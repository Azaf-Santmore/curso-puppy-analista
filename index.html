<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curso: El Sabueso de Datos Pol√≠ticos üêæ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0a09; /* Zinc-950 */
            color: #d1d5db; /* Gray-300 */
            overflow: hidden; /* Hide main body overflow */
        }
        .neon-border {
            border: 2px solid;
            border-image: linear-gradient(45deg, #10b981, #f43f5e, #8b5cf6, #06b6d4) 1;
            box-shadow: 0 0 15px #f43f5e, 0 0 30px #8b5cf6;
        }
        .neon-text {
            text-shadow: 0 0 5px #f43f5e, 0 0 10px #8b5cf6;
        }
        .module-card {
            background: rgba(15, 23, 42, 0.7); /* Slate-900 with transparency */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(51, 65, 85, 0.5); /* Slate-700 with transparency */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 10px 15px rgba(0, 0, 0, 0.2);
        }
        .progress-line {
            height: 2px;
            background-color: #4b5563;
        }
        .progress-line-completed {
            background-color: #10b981;
        }
        #chat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }
        .chat-content {
            background-color: #1f2937;
            border-radius: 1rem;
            border: 2px solid #3b82f6;
            box-shadow: 0 0 20px #3b82f6;
        }
        .draggable {
            cursor: grab;
            transition: transform 0.2s;
        }
        .draggable:active {
            cursor: grabbing;
        }
        .dropzone {
            min-height: 4rem;
            border: 2px dashed #64748b;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: all 0.2s;
            position: relative;
        }
        .dropzone.hovered {
            background-color: rgba(100, 116, 139, 0.2);
            border-color: #3b82f6;
            border-style: solid;
            box-shadow: 0 0 10px #3b82f6;
        }
        /* Sidebar Styling */
        #sidebar {
            width: 250px;
            background: rgba(22, 28, 42, 0.9);
            border-right: 1px solid rgba(51, 65, 85, 0.5);
            padding: 1rem;
            overflow-y: auto;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 50;
        }
        #course-content-container {
            margin-left: 250px;
            padding: 2rem;
            height: 100vh;
            overflow-y: auto;
        }
        @media (max-width: 1024px) {
            #sidebar {
                position: relative;
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid rgba(51, 65, 85, 0.5);
            }
            #course-content-container {
                margin-left: 0;
                padding-top: 1rem;
            }
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease, transform 0.2s ease;
            cursor: pointer;
            color: #9ca3af;
        }
        .sidebar-item.completed {
            background-color: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }
        .sidebar-item.active {
            background-color: rgba(244, 63, 94, 0.1);
            color: #f43f5e;
            transform: scale(1.05);
        }
        .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        pre {
            background-color: #1e293b;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }

        /* Nueva animaci√≥n para el bot√≥n del asistente */
        @keyframes bounce-animation {
            0%, 100% { transform: scale(1) translateY(0); }
            50% { transform: scale(1.1) translateY(-5px); }
        }
        .animate-bounce {
            animation: bounce-animation 2s infinite ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .fade-in {
            animation: fadeIn 1.5s ease-in-out;
        }
        .drag-correct {
            border-color: #10b981;
            box-shadow: 0 0 10px #10b981;
        }
        .drag-incorrect {
            border-color: #f43f5e;
            box-shadow: 0 0 10px #f43f5e;
        }
        /* New Styles for Pie Chart Animation */
        .pie-chart-container {
            position: relative;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(
                #f43f5e 0% 30%,
                #8b5cf6 30% 60%,
                #06b6d4 60% 100%
            );
            transition: all 1s ease-in-out;
            animation: fillPie 2s ease-in-out;
        }
        @keyframes fillPie {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .pie-slice {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            clip-path: polygon(50% 50%, 50% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 0%);
        }
        /* New Styles for Bar Chart Animation */
        .bar-chart-container {
            width: 100%;
            height: 150px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            padding-top: 10px;
            border-bottom: 2px solid #94a3b8;
        }
        .bar {
            width: 30px;
            background-color: #06b6d4;
            transition: height 1s ease-in-out;
            animation: fillBar 1.5s ease-in-out;
        }
        @keyframes fillBar {
            from { height: 0; }
            to { height: var(--bar-height); }
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-300">

    <!-- Pantalla de Inicio -->
    <div id="intro-screen" class="w-full h-screen flex flex-col items-center justify-center p-8">
        <div class="w-full max-w-lg p-8 module-card rounded-xl">
            <div class="flex flex-col items-center text-center">
                <h1 class="text-4xl font-bold neon-text text-cyan-400 mb-4">¬°Curso de Entrenamiento Canino Pol√≠tico! üê∂</h1>
                <p class="mb-6 text-gray-400">
                    ¬°Bienvenido, futuro sabueso de datos! Puppy Chiquito Pol√≠tico necesita de tu ayuda para su campa√±a.
                    Antes de empezar a olfatear datos, necesitamos que nos des tu informaci√≥n.
                </p>
                <form id="start-form" class="w-full space-y-4">
                    <div>
                        <label for="dog-name" class="block mb-2 text-sm font-medium text-cyan-300">¬øCu√°l es tu nombre perruno? üêæ</label>
                        <input type="text" id="dog-name" placeholder="Ej: Fido El Audaz" required class="w-full p-3 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:border-cyan-500">
                    </div>
                    <div>
                        <label for="full-name" class="block mb-2 text-sm font-medium text-cyan-300">Tu nombre completo (para el certificado) üèÖ</label>
                        <input type="text" id="full-name" placeholder="Ej: John Doe" required class="w-full p-3 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:border-cyan-500">
                    </div>
                    <button type="submit" class="w-full py-3 mt-4 text-lg font-bold rounded-lg text-white transition-all duration-300 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600">
                        ¬°A Cazar Datos! üêï
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Pantalla del Curso con Sidebar -->
    <div id="course-screen" class="hidden lg:flex w-full h-screen">
        <!-- Sidebar de navegaci√≥n -->
        <nav id="sidebar" class="w-1/4 max-w-xs flex flex-col">
            <h3 class="text-2xl font-bold neon-text text-cyan-400 mb-4">Temario üìú</h3>
            <div id="sidebar-modules" class="flex-grow space-y-2"></div>
        </nav>
        
        <!-- Contenido principal del curso -->
        <main id="course-content-container" class="flex-grow">
            <!-- Barra de Progreso -->
            <div id="progress-bar-container" class="mb-6 p-4 module-card rounded-xl">
                <div class="text-sm font-bold text-cyan-300 flex justify-between mb-2">
                    <span>Progreso del Curso:</span>
                    <span id="progress-percentage" class="neon-text">0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div id="progress-indicator" class="h-2 rounded-full transition-all duration-700 ease-in-out bg-gradient-to-r from-green-400 to-teal-500" style="width: 0%"></div>
                </div>
            </div>
            
            <h2 id="course-title" class="text-3xl font-bold neon-text text-cyan-400 mb-4 text-center"></h2>
            <div id="module-container" class="min-h-[500px]">
                <!-- Contenido del m√≥dulo y preguntas se renderizar√°n aqu√≠ -->
            </div>
        </main>
    </div>

    <!-- Bot√≥n del Asistente de IA -->
    <button id="ai-assistant-button" class="fixed bottom-8 right-8 z-50 w-16 h-16 rounded-full bg-blue-500 flex items-center justify-center text-4xl shadow-lg hover:scale-110 transition-transform duration-300 cursor-pointer animate-bounce">
        üê∂
    </button>

    <!-- Modal del Asistente de IA -->
    <div id="chat-modal" class="fixed inset-0 flex items-center justify-center p-4 z-[1000]">
        <div class="chat-content w-full max-w-md h-3/4 flex flex-col p-4 rounded-xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-cyan-300">Asistente de Campa√±a üêï‚Äçü¶∫</h3>
                <button id="close-chat-button" class="text-gray-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <div id="chat-messages" class="flex-grow overflow-y-auto space-y-4 p-2 bg-gray-800 rounded-lg mb-4">
                <div class="text-center text-gray-400 italic">¬°Guau! Estoy listo para ayudarte. ¬øEn qu√© tienes dudas?</div>
            </div>
            <div class="flex">
                <input type="text" id="chat-input" placeholder="Preg√∫ntale al Asistente..." class="flex-grow p-3 rounded-l-lg bg-gray-700 text-white focus:outline-none border border-gray-600">
                <button id="send-chat-button" class="px-4 py-3 bg-blue-600 rounded-r-lg text-white hover:bg-blue-700 transition-colors duration-200">
                    Enviar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de la API de Gemini y el curso
        const API_KEY = "AIzaSyAisbDrYyve2jOmoXuSYbNKu5Z5FNSlB3E";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const resourcesLink = "https://docs.google.com/spreadsheets/d/12jt1jKI8Z7yDKU1LZnEX0gM1eyUqK-Y7fbeswfUNoMA/edit?usp=sharing";

        // Estado de la aplicaci√≥n
        let currentModuleIndex = 0;
        let userName = '';
        let fullName = '';
        let completedModules = [];
        let score = 0;
        let isFinalModule = false;

        // Contenido del curso
        const modules = [
            {
                phase: 'Fase 1: El Olfato Anal√≠tico üêæ',
                title: 'M√≥dulo 1: Presentando a Puppy y su Partido PUP',
                emoji: 'üê∂',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Conoce a Puppy Chiquito Pol√≠tico y el Partido PUP</h3>
                    <p class="text-gray-400 mb-4">
                        ¬°Guau! ¬°Bienvenido, futuro sabueso de datos! Puppy Chiquito Pol√≠tico, un adorable cachorro mestizo de la CDMX, tiene un gran sue√±o: ser diputado para mejorar la vida de todos. Su partido se llama **PUP: Patitas Unidas para el Pueblo**. üêæ Juntos, vamos a usar el poder de los datos para ganar la elecci√≥n. ¬°Tu primera misi√≥n es aprender a olfatear los datos correctos!
                    </p>
                    <div class="mt-8 flex justify-center">
                        <!-- IMAGEN DE PUPPY CHIQUITO POL√çTICO: ADVERTENCIA: Esta URL de Drive a menudo requiere que la imagen sea p√∫blica para que se muestre correctamente. Si no carga, deber√°s generar un enlace de uso compartido directo. -->
                        <img src="https://lh3.googleusercontent.com/pw/AP1GczN22RO_Ty-koYBMNNea5HlPCfKK0gXqil9l8qEMrtel67_CusU39vQte6vajns5SoO3pH3F6Zd5dRlZYxnt-8b8vuQBfiIjryCNRqoRuiYHf54Amxk07Jm3efL03dO-b8dV-tVX9B0Y61eueU9sJUzzLg=w500-h500-s-no-gm?authuser=0" 
                             alt="Puppy Chiquito Pol√≠tico con un traje peque√±o" 
                             class="w-64 h-auto rounded-lg shadow-xl neon-border transition-all duration-300 hover:scale-[1.02]">
                    </div>
                `,
                type: 'multipleChoice',
                question: '¬øCu√°l es el nombre del partido de Puppy Chiquito Pol√≠tico?',
                options: ['Perros Unidos Partidarios', 'Patitas Unidas para el Pueblo', 'Perros Urbanos y Patriotas'],
                answer: 'Patitas Unidas para el Pueblo'
            },
            {
                phase: 'Fase 1: El Olfato Anal√≠tico üêæ',
                title: 'M√≥dulo 2: El Recinto Canino: Tu primer Google Sheet',
                emoji: 'üìä',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Misi√≥n: ¬°Preparar el Recinto Canino! üìä</h3>
                    <p class="text-gray-400 mb-4">
                        ¬°La campa√±a ha empezado! El primer paso es organizar la informaci√≥n de los votantes. La herramienta principal de nuestro equipo es Google Sheets. Piensa en ella como un gran parque lleno de datos, donde cada hoja es un √°rea cercada y cada celda una huella. ¬°Es el lugar perfecto para organizar toda la informaci√≥n de nuestros votantes! üêæ
                    </p>
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-amber-300 mb-2">Recreaci√≥n de Google Sheets:</h4>
                        <img src="https://placehold.co/600x200/292524/e7e5e4?text=Interfaz+de+Google+Sheets" alt="Interfaz de Google Sheets" class="w-full h-auto rounded-lg shadow-lg mb-4">
                        <p class="text-gray-400 italic">
                            Puedes ver un ejemplo de la hoja de c√°lculo. Para esta actividad, dir√≠gete al taz√≥n de recursos y haz una copia para tu propio uso.
                        </p>
                    </div>
                    <div class="flex justify-center mt-6">
                        <a href="https://docs.google.com/spreadsheets/d/12jt1jKI8Z7yDKU1LZnEX0gM1eyUqK-Y7fbeswfUNoMA/edit?usp=sharing" target="_blank" class="py-3 px-6 text-lg font-bold rounded-lg text-white transition-all duration-300 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600">
                            Ir al Taz√≥n de Recursos üêæ
                        </a>
                    </div>
                `,
                type: 'multipleChoice',
                question: 'En el taz√≥n de recursos, ¬øqu√© columna representa el tipo de votante de acuerdo con su afinidad por perros o gatos?',
                options: ['Nombre_Completo', 'Tipo_Votante', 'Voto_Encuesta'],
                answer: 'Tipo_Votante'
            },
            {
                phase: 'Fase 1: El Olfato Anal√≠tico üêæ',
                title: 'M√≥dulo 3: La Pista de Huellas: Datos Sucios vs. Limpios',
                emoji: 'üîç',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Misi√≥n: ¬°Olfatea la suciedad! üîç</h3>
                    <p class="text-gray-400 mb-4">
                        Al recolectar la informaci√≥n, algunas huellas (los datos) est√°n llenas de barro: nombres mal escritos, edades que no tienen sentido, campos vac√≠os. Esto es lo que llamamos "datos sucios". Nuestro trabajo como sabuesos es limpiar este barro para que el camino sea claro. üßº
                    </p>
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-amber-300 mb-2">Ejemplo Visual de Datos Sucios vs. Limpios:</h4>
                        <img src="https://placehold.co/600x200/292524/e7e5e4?text=Datos+limpios+vs.+Datos+sucios" alt="Datos limpios versus datos sucios" class="w-full h-auto rounded-lg shadow-lg mb-4">
                        <p class="text-gray-400 italic">Mira los datos que tenemos. La limpieza es el primer paso.</p>
                    </div>
                `,
                type: 'dragAndDrop',
                question: '¬°Guau! Arrastra la tarjeta que representa un "dato sucio" y "dato limpio" basado en el tipo de votante de nuestra tabla.',
                dragItems: [
                    { id: 'item-1', text: 'Amante de gatos' },
                    { id: 'item-2', text: 'amantedegatos' }
                ],
                dropTargets: [
                    { id: 'target-1', text: 'Dato Limpio ‚ú®' },
                    { id: 'target-2', text: 'Dato Sucio üí©' }
                ],
                correctMapping: {
                    'item-1': 'target-1',
                    'item-2': 'target-2'
                }
            },
            {
                phase: 'Fase 2: Estrategia de Manada üê∂',
                title: 'M√≥dulo 4: El Rastreador GPS: Usando BUSCARX',
                emoji: 'üìç',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Misi√≥n: ¬°No m√°s vueltas en c√≠rculos! üó∫Ô∏è</h3>
                    <p class="text-gray-400 mb-4">
                        Puppy quiere mandarle un huesito personalizado a un votante con "ID_Votante" **V004**, pero necesita su colonia. Con la funci√≥n **=BUSCARX()**, podemos encontrar cualquier dato sin importar d√≥nde est√©. Es nuestro rastreador GPS para los votantes. Es m√°s poderosa y flexible que BUSCARV y BUSCARH. Es ideal para encontrar un dato de forma precisa y r√°pida.
                    </p>
                    <p class="text-gray-400 mb-4">
                        Su sintaxis es simple: **=BUSCARX(lo_que_buscas, rango_donde_buscar, rango_donde_devolver)**
                    </p>
                `,
                type: 'multipleChoice',
                question: 'Si Puppy quiere saber en qu√© colonia vive el votante con "ID_Votante" V004, ¬øqu√© f√≥rmula usar√≠as?',
                options: ['=BUSCARV("V004", A:D, 4, FALSO)', '=BUSCARX("V004", A:A, D:D)', '=BUSCARX("V004", D:D, A:A)'],
                answer: '=BUSCARX("V004", A:A, D:D)'
            },
            {
                phase: 'Fase 2: Estrategia de Manada üê∂',
                title: 'M√≥dulo 5: El Olfato de Grupo: Filtrando datos con FILTER',
                emoji: 'üëÉ',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Misi√≥n: ¬°Olfateando solo a los importantes! üëÉ</h3>
                    <p class="text-gray-400 mb-4">
                        Puppy planea un evento en el Parque M√©xico y solo necesita la lista de votantes de la colonia **Condesa**. Con la funci√≥n **=FILTER()**, podemos crear una lista de votantes que cumplan con un criterio espec√≠fico. Es como separar a los cachorros de los perros adultos para un juego. üêï‚Äçü¶∫
                    </p>
                    <p class="text-gray-400 mb-4">
                        La sintaxis es: **=FILTER(rango_a_filtrar, condici√≥n1, [condici√≥n2, ...])**.
                    </p>
                `,
                type: 'multipleChoice',
                question: '¬øQu√© f√≥rmula usar√≠as para crear una nueva tabla solo con los votantes de la colonia "Condesa"?',
                options: ['=FILTRAR(A:E, D:D="Condesa")', '=BUSCARX(A:E, D:D="Condesa")', '=BUSCARV(D:D="Condesa")'],
                answer: '=FILTRAR(A:E, D:D="Condesa")'
            },
            {
                phase: 'Fase 2: Estrategia de Manada üê∂',
                title: 'M√≥dulo 6: El Ladrido de Prioridad: Valores Booleanos',
                emoji: 'üö®',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Misi√≥n: ¬øQui√©n necesita m√°s atenci√≥n? üö®</h3>
                    <p class="text-gray-400 mb-4">
                        Para la campa√±a, necesitamos identificar a los votantes indecisos de las colonias clave. Un valor booleano (**VERDADERO** o **FALSO**) nos ayuda a saber si un votante cumple con m√∫ltiples condiciones. Es la forma m√°s r√°pida de decir "¬°s√≠, este votante es importante!" o "¬°no, este votante no es una prioridad ahora!". üêæ
                    </p>
                    <p class="text-gray-400 mb-4">
                        Las funciones clave son **=Y()** para que todas las condiciones sean VERDADERO, y **=O()** para que al menos una sea VERDADERO.
                    </p>
                `,
                type: 'multipleChoice',
                question: '¬øQu√© f√≥rmula usar√≠as para marcar con VERDADERO a los votantes que son "Indeciso" Y de la colonia "La Roma"?',
                options: ['=Y(C2="Indeciso", D2="La Roma")', '=O(C2="Indeciso", D2="La Roma")', '=SI(C2="Indeciso")'],
                answer: '=Y(C2="Indeciso", D2="La Roma")'
            },
            {
                phase: 'Fase 2: Estrategia de Manada üê∂',
                title: 'M√≥dulo 7: Conectando Datos con L√≥gica: La Cacer√≠a Perfecta',
                emoji: 'üîó',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Misi√≥n: ¬°La cacer√≠a perfecta! üéØ</h3>
                    <p class="text-gray-400 mb-4">
                        ¬°El equipo de campa√±a descubri√≥ un problema! Muchos votantes en La Roma han mencionado la palabra "tr√°fico" en sus comentarios. Puppy necesita saber exactamente qui√©nes son para poder hacerles llegar un mensaje especial sobre sus propuestas para mejorar la movilidad. ¬°Tu misi√≥n es usar tus habilidades de sabueso para crear esa lista! üêï‚Äçü¶∫
                    </p>
                `,
                type: 'dragAndDrop',
                question: 'Arrastra las funciones para crear la f√≥rmula que filtra a los votantes que mencionan "tr√°fico" en sus comentarios.',
                dragItems: [
                    { id: 'item-1', text: 'FILTER(' },
                    { id: 'item-2', text: 'F:F' },
                    { id: 'item-3', text: 'BUSCAR("tr√°fico", F:F))' }
                ],
                dropTargets: [
                    { id: 'target-1', text: '=FILTER(' },
                    { id: 'target-2', text: 'Rango a filtrar' },
                    { id: 'target-3', text: 'Condici√≥n' }
                ],
                correctMapping: {
                    'item-1': 'target-1',
                    'item-2': 'target-2',
                    'item-3': 'target-3'
                }
            },
            {
                phase: 'Fase 3: Visualizaci√≥n de Terreno üó∫Ô∏è',
                title: 'M√≥dulo 8: El Resumen de la Manada: Tablas Din√°micas',
                emoji: 'üìù',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Misi√≥n: ¬øEn qu√© colonia tiene m√°s aliados Puppy? üìä</h3>
                    <p class="text-gray-400 mb-4">
                        El equipo de campa√±a necesita saber r√°pidamente en qu√© colonias tenemos m√°s aliados para enfocar sus paseos. Contar manualmente ser√≠a un desastre. La soluci√≥n es una **Tabla Din√°mica**. Con ella, podemos resumir grandes cantidades de datos en una tabla f√°cil de leer para tomar decisiones r√°pidas. ¬°Es como contar cu√°ntos perros de cada raza hay en un parque! üêæ
                    </p>
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-amber-300 mb-2">Tabla Din√°mica de Muestra:</h4>
                        <p class="text-gray-400 mb-2 italic">Puedes recrear esto en Google Sheets usando los datos del curso.</p>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-gray-400">
                                <thead class="text-xs uppercase bg-gray-700 text-gray-300">
                                    <tr>
                                        <th scope="col" class="py-3 px-6">Colonia</th>
                                        <th scope="col" class="py-3 px-6">Conteo de ID_Votante</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="bg-gray-800 border-b border-gray-700">
                                        <td class="py-4 px-6 font-medium text-white">La Roma</td>
                                        <td class="py-4 px-6">5</td>
                                    </tr>
                                    <tr class="bg-gray-800 border-b border-gray-700">
                                        <td class="py-4 px-6 font-medium text-white">Condesa</td>
                                        <td class="py-4 px-6">4</td>
                                    </tr>
                                    <tr class="bg-gray-800">
                                        <td class="py-4 px-6 font-medium text-white">Polanco</td>
                                        <td class="py-4 px-6">3</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `,
                type: 'multipleChoice',
                question: 'Para crear una Tabla Din√°mica en Sheets, ¬øqu√© campo pondr√≠as en "Filas" para contar votantes por colonia?',
                options: ['Colonia', 'Nombre_Completo', 'Voto_Encuesta'],
                answer: 'Colonia'
            },
            {
                phase: 'Fase 3: Visualizaci√≥n de Terreno üó∫Ô∏è',
                title: 'M√≥dulo 9: El Mapa de Votantes: Gr√°ficos de Resumen',
                emoji: 'üó∫Ô∏è',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Misi√≥n: El camino de Puppy a la victoria. üìà</h3>
                    <p class="text-gray-400 mb-4">
                        Gracias a tu Tabla Din√°mica, Puppy sabe que "La Roma" y "Condesa" tienen muchos votantes. Para que el equipo lo entienda mejor, crea un gr√°fico de pastel. As√≠ podr√°n visualizar r√°pidamente el porcentaje de aliados por colonia y planificar su campa√±a. ¬°Un gr√°fico bien hecho vale m√°s que mil ladridos! üé®
                    </p>
                    <div class="mt-8 flex justify-center items-center h-64 bg-gray-800 rounded-lg">
                        <div class="pie-chart-container"></div>
                    </div>
                `,
                type: 'multipleChoice',
                question: 'Una vez que tienes los datos resumidos en la Tabla Din√°mica, ¬øqu√© tipo de gr√°fico es ideal para mostrar la distribuci√≥n de votantes por colonia?',
                options: ['Gr√°fico de barras', 'Gr√°fico de pastel', 'Gr√°fico de l√≠neas'],
                answer: 'Gr√°fico de pastel'
            },
            {
                phase: 'Fase 3: Visualizaci√≥n de Terreno üó∫Ô∏è',
                title: 'M√≥dulo 10: Sem√°foro de Prioridad: Formato Condicional',
                emoji: 'üö¶',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Misi√≥n: ¬°Colorea lo m√°s importante! üö•</h3>
                    <p class="text-gray-400 mb-4">
                        Ahora, Puppy necesita analizar la efectividad de sus visitas a las colonias. Vas a usar el **Formato Condicional** para que, en la columna "Voto_Encuesta", las celdas con "S√≠" se pongan verdes, "No" se pongan rojas e "Indeciso" se pongan amarillas. Es como un sem√°foro de apoyo pol√≠tico.
                    </p>
                    <div class="mt-8 flex justify-center items-center">
                        <img src="https://placehold.co/600x200/292524/e7e5e4?text=Formato+Condicional+de+Ejemplo" alt="Ejemplo de Formato Condicional en Google Sheets" class="rounded-lg shadow-lg">
                    </div>
                `,
                type: 'dragAndDrop',
                question: 'Arrastra los colores al tipo de voto correcto para el Formato Condicional.',
                dragItems: [
                    { id: 'item-1', text: 'Verde' },
                    { id: 'item-2', text: 'Rojo' },
                    { id: 'item-3', text: 'Amarillo' }
                ],
                dropTargets: [
                    { id: 'target-1', text: '"S√≠"' },
                    { id: 'target-2', text: '"No"' },
                    { id: 'target-3', text: '"Indeciso"' }
                ],
                correctMapping: {
                    'item-1': 'target-1',
                    'item-2': 'target-2',
                    'item-3': 'target-3'
                }
            },
            {
                phase: 'Fase 4: El Perro Robot ü§ñ',
                title: 'M√≥dulo 11: La Pericia del Sabueso: Automatizaci√≥n',
                emoji: 'ü§ñ',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Misi√≥n: ¬°Deja que el perro haga el trabajo! ‚öôÔ∏è</h3>
                    <p class="text-gray-400 mb-4">
                        Un sabueso inteligente no persigue la misma ardilla todos los d√≠as. La automatizaci√≥n, usando Google App Script, nos permite ense√±ar a las hojas de c√°lculo a hacer el trabajo repetitivo por nosotros. Podemos programar tareas como enviar correos, generar reportes o actualizar datos autom√°ticamente. ¬°Es como tener un perro robot que hace el trabajo por ti!
                    </p>
                `,
                type: 'multipleChoice',
                question: '¬øQu√© herramienta se utiliza para automatizar tareas en Google Sheets?',
                options: ['Google Forms', 'Google App Script', 'Google Docs'],
                answer: 'Google App Script'
            },
            {
                phase: 'Fase 4: El Perro Robot ü§ñ',
                title: 'M√≥dulo 12: Escribiendo tu Primer Script con ayuda de IA üßπ',
                emoji: '‚å®Ô∏è',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Misi√≥n: ¬°Una pata al c√≥digo con IA! ü§ñ</h3>
                    <p class="text-gray-400 mb-4">
                        Puppy se da cuenta de que los nuevos datos de encuestas llegan con espacios extra y letras min√∫sculas en los nombres. Tu misi√≥n es crear un script que limpie la columna **Nombre_Completo**.
                        <br>
                        En lugar de darte el c√≥digo fijo, te mostraremos c√≥mo usar una IA para que genere el c√≥digo por ti. ¬°As√≠ es como los analistas modernos trabajan! Ve a **'Extensiones' > 'Apps Script'** en tu Google Sheet.
                    </p>
                    <p class="text-gray-400 mb-4">
                        Usa un prompt como este en una IA (como nuestro asistente o cualquier otra):
                        <pre><code>"Necesito un script en Google Apps Script para una hoja de c√°lculo. El script debe limpiar los datos en la columna B, eliminando espacios al inicio y al final, y convirtiendo la primera letra de cada palabra a may√∫scula. Debe procesar todas las filas con datos y sobrescribir los valores en su lugar."</code></pre>
                    </p>
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-purple-300 mb-2">Recreaci√≥n de la interfaz de Apps Script:</h4>
                        <img src="https://placehold.co/600x200/292524/e7e5e4?text=Interfaz+de+Apps+Script" alt="Interfaz de Apps Script" class="w-full h-auto rounded-lg shadow-lg mb-4">
                    </div>
                    <p class="text-gray-400 mt-4 italic">
                        ¬øNecesitas ayuda con el prompt o no funciona el c√≥digo? ¬°Preg√∫ntale a nuestro asistente de IA integrado! üêï‚Äçü¶∫
                    </p>
                `,
                type: 'multipleChoice',
                question: '¬øQu√© hace el m√©todo `.trim()` en un script de JavaScript?',
                options: ['Convierte el texto a may√∫sculas.', 'Elimina los espacios al inicio y final del texto.', 'Cambia el color de la celda.'],
                answer: 'Elimina los espacios al inicio y final del texto.'
            },
            {
                phase: 'Fase 4: El Perro Robot ü§ñ',
                title: 'M√≥dulo 13: La Campa√±a en Piloto Autom√°tico',
                emoji: '‚öôÔ∏è',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Misi√≥n: ¬°Tareas autom√°ticas! ‚öôÔ∏è</h3>
                    <p class="text-gray-400 mb-4">
                        Para que el equipo de Puppy no tenga que correr el script cada vez, vamos a crear un activador. Esto har√° que el script se ejecute autom√°ticamente cada vez que se a√±adan nuevos datos de encuesta.
                        <br>
                        En App Script, ve a **'Activadores' (Trigger)** y crea uno para que tu script 'limpiarNombres' se ejecute **"Al enviar el formulario"**. üöÄ
                    </p>
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-purple-300 mb-2">Diagrama de Flujo del Activador:</h4>
                        <img src="https://placehold.co/600x200/292524/e7e5e4?text=Diagrama+de+flujo+de+automatizaci√≥n" alt="Diagrama de flujo de automatizaci√≥n" class="w-full h-auto rounded-lg shadow-lg mb-4">
                    </div>
                    <p class="text-gray-400 mt-4 italic">
                        ¬øNecesitas ayuda con alg√∫n paso o te perdiste? ¬°Preg√∫ntale a nuestro asistente de IA integrado! üêï‚Äçü¶∫
                    </p>
                `,
                type: 'multipleChoice',
                question: '¬øQu√© opci√≥n en Apps Script te permite programar la ejecuci√≥n de un script?',
                options: ['Run', 'Activadores', 'Debug'],
                answer: 'Activadores'
            },
            {
                phase: 'Fase 5: El Instinto de Liderazgo üß†',
                title: 'M√≥dulo 14: La IA en el An√°lisis de Datos',
                emoji: 'üß†',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Misi√≥n: ¬°Aprende del instinto! üß†</h3>
                    <p class="text-gray-400 mb-4">
                        La IA es el instinto de la manada. Nos ayuda a predecir el comportamiento de los votantes, segmentar audiencias y personalizar mensajes de campa√±a a una escala masiva. Con la IA, podemos ir m√°s all√° de los datos que tenemos y predecir lo que va a pasar, como un perro que sabe cu√°ndo va a llover. ‚òî
                    </p>
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-cyan-300 mb-2">Ilustraci√≥n de IA:</h4>
                        <img src="https://placehold.co/600x200/292524/e7e5e4?text=Inteligencia+artificial+analizando+datos" alt="Inteligencia artificial analizando datos" class="w-full h-auto rounded-lg shadow-lg mb-4">
                    </div>
                `,
                type: 'multipleChoice',
                question: '¬øCu√°l es el beneficio clave de usar IA en una campa√±a?',
                options: ['Permite predecir el comportamiento de los votantes y segmentar audiencias, ayudando a personalizar mensajes.', 'Genera gr√°ficos autom√°ticos en Google Sheets.', 'Crea correos electr√≥nicos masivos.'],
                answer: 'Permite predecir el comportamiento de los votantes y segmentar audiencias, ayudando a personalizar mensajes.'
            },
            {
                phase: 'Fase 5: El Instinto de Liderazgo üß†',
                title: 'M√≥dulo 15: Segmentaci√≥n de Manadas',
                emoji: 'üß©',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Misi√≥n: ¬°Dividir para conquistar! üß©</h3>
                    <p class="text-gray-400 mb-4">
                        La IA nos ayuda a segmentar a los votantes en grupos (manadas). Una manada puede ser de votantes j√≥venes interesados en el medio ambiente, y otra de votantes mayores preocupados por la seguridad. Cada manada recibe un mensaje adaptado a sus intereses. üó£Ô∏è
                    </p>
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-cyan-300 mb-2">Diagrama de Segmentaci√≥n:</h4>
                        <img src="https://placehold.co/600x200/292524/e7e5e4?text=Una+poblaci√≥n+segmentada+en+grupos" alt="Una poblaci√≥n segmentada en grupos" class="w-full h-auto rounded-lg shadow-lg mb-4">
                    </div>
                `,
                type: 'multipleChoice',
                question: '¬øQu√© es la segmentaci√≥n de votantes?',
                options: ['Dividir a los votantes en grupos basados en caracter√≠sticas comunes.', 'Contar el n√∫mero total de votantes en una base de datos.', 'Analizar el perfil de los candidatos rivales.'],
                answer: 'Dividir a los votantes en grupos basados en caracter√≠sticas comunes.'
            },
            {
                phase: 'Fase 5: El Instinto de Liderazgo üß†',
                title: 'M√≥dulo 16: Prediciendo el Comportamiento',
                emoji: 'üîÆ',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Misi√≥n: ¬°Olfateando el futuro! üîÆ</h3>
                    <p class="text-gray-400 mb-4">
                        Con modelos de IA, podemos predecir si un votante es "indeciso" o "fiel". Esta informaci√≥n nos permite enfocar nuestros recursos en aquellos que son m√°s propensos a cambiar su voto. ¬°Es como saber qui√©n te va a dar una galleta antes de que la saquen! üç™
                    </p>
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-cyan-300 mb-2">Modelo de Predicci√≥n:</h4>
                        <img src="https://placehold.co/600x200/292524/e7e5e4?text=Gr√°fico+de+modelo+predictivo" alt="Gr√°fico de modelo predictivo" class="w-full h-auto rounded-lg shadow-lg mb-4">
                    </div>
                `,
                type: 'multipleChoice',
                question: '¬øQu√© es un modelo de IA en una campa√±a?',
                options: ['Una maqueta de la sede del partido.', 'Un programa que predice el comportamiento de los votantes.', 'Un tipo de gr√°fico en Looker Studio.'],
                answer: 'Un programa que predice el comportamiento de los votantes.'
            },
            {
                phase: 'Fase 6: La Victoria üèÜ',
                title: 'M√≥dulo 17: Medici√≥n de Ladrido: Campos Calculados en Looker Studio',
                emoji: 'üìè',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Misi√≥n: ¬°M√°s all√° de lo obvio! üéØ</h3>
                    <p class="text-gray-400 mb-4">
                        El equipo de campa√±a quiere saber si la campa√±a est√° resonando con los j√≥venes. En Looker Studio, vamos a usar un **Campo Calculado** para clasificar a los votantes por grupos de edad: "Joven" (menor de 30), "Adulto" (30-50) y "Senior" (mayor de 50). As√≠ podemos medir el impacto de Puppy en cada grupo.
                    </p>
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-rose-300 mb-2">Recreaci√≥n de la interfaz de Looker Studio:</h4>
                        <div class="bg-gray-900 rounded-lg p-4">
                            <h5 class="text-sm text-gray-400 mb-2">Pesta√±a de "Campos Calculados"</h5>
                            <pre class="bg-gray-900 text-green-300 overflow-x-auto"><code>CASE WHEN Edad < 30 THEN "Joven"
     WHEN Edad >= 30 AND Edad <= 50 THEN "Adulto"
     ELSE "Senior"
END</code></pre>
                        </div>
                    </div>
                `,
                type: 'multipleChoice',
                question: '¬øQu√© funci√≥n usar√≠as para crear un campo calculado que clasifique la edad de los votantes en "Joven", "Adulto" o "Senior"?',
                options: ['CASE WHEN Edad < 30 THEN "Joven"', 'SUM(Edad)', 'COUNT(Edad)'],
                answer: 'CASE WHEN Edad < 30 THEN "Joven"'
            },
            {
                phase: 'Fase 6: La Victoria üèÜ',
                title: 'M√≥dulo 18: El Rastro del √âxito: An√°lisis Avanzado',
                emoji: 'üìä',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Misi√≥n: ¬°Los datos cuentan la historia! üìà</h3>
                    <p class="text-gray-400 mb-4">
                        Al revisar tu dashboard, notas que los "Amigos de Gatos" de "La Roma" tienen muchos comentarios negativos sobre el tr√°fico. Con un campo calculado, podemos crear un "√çndice de Resentimiento" para cada colonia. ¬°Es una m√©trica clave para el equipo de campa√±a!
                    </p>
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-rose-300 mb-2">Recreaci√≥n del Dashboard en Looker Studio:</h4>
                        <img src="https://placehold.co/600x200/292524/e7e5e4?text=un+panel+de+control+final" alt="un panel de control final" class="w-full h-auto rounded-lg shadow-lg mb-4">
                    </div>
                `,
                type: 'multipleChoice',
                question: 'Para crear un "√çndice de Resentimiento" que cuente los comentarios negativos por colonia, ¬øqu√© tipo de campo calculado usar√≠as?',
                options: ['Uno que cuente los comentarios positivos.', 'Uno que sume la edad de los votantes.', 'Uno que cuente las menciones de "tr√°fico" o "problema".'],
                answer: 'Uno que cuente las menciones de "tr√°fico" o "problema".'
            },
            {
                phase: 'Fase 6: La Victoria üèÜ',
                title: 'M√≥dulo 19: El Cierre de Campa√±a: Decisiones Basadas en Datos',
                emoji: 'üéâ',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Misi√≥n: ¬°El √∫ltimo ladrido! üêæ</h3>
                    <p class="text-gray-400 mb-4">
                        Gracias a tu trabajo, Puppy Chiquito Pol√≠tico ha optimizado sus recursos. Al analizar tus dashboards, notaste que los votantes j√≥venes de "La Roma" son clave. Usando los datos de "Comentarios_Encuesta", creaste mensajes espec√≠ficos sobre la seguridad y el tr√°fico. ¬°La campa√±a est√° en su punto m√°s alto! ü•≥
                    </p>
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-rose-300 mb-2">Estrategia Final de Puppy:</h4>
                        <img src="https://placehold.co/600x200/292524/e7e5e4?text=Estrategia+Basada+en+Datos" alt="Estrategia Basada en Datos" class="w-full h-auto rounded-lg shadow-lg mb-4">
                    </div>
                `,
                type: 'multipleChoice',
                question: '¬øQu√© habilidad de las aprendidas fue crucial para el √©xito del evento en La Roma?',
                options: ['Identificar votantes indecisos y sus preocupaciones a trav√©s de los datos.', 'Distribuir volantes en toda la ciudad.', 'Contratar a un entrenador canino famoso.'],
                answer: 'Identificar votantes indecisos y sus preocupaciones a trav√©s de los datos.'
            },
            {
                phase: 'Fase 7: El Legado üèÖ',
                title: 'M√≥dulo 20: El d√≠a de la elecci√≥n',
                emoji: 'üó≥Ô∏è',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Misi√≥n: ¬°Aullidos de victoria! üèÜ</h3>
                    <p class="text-gray-400 mb-4">
                        ¬°Lo lograste! El conteo de votos ha terminado y Puppy Chiquito Pol√≠tico, gracias a tu ayuda, ha sido electo diputado de la Ciudad de M√©xico. Tu trabajo como analista de datos fue crucial para esta hist√≥rica victoria. Ahora, solo queda celebrar. ü•≥üéâ
                    </p>
                `,
                type: 'multipleChoice',
                question: '¬øQu√© aprendiste sobre el an√°lisis de datos para campa√±as pol√≠ticas?',
                options: ['Es una herramienta para contar votos.', 'Es una herramienta estrat√©gica para la toma de decisiones.', 'Solo sirve para hacer gr√°ficos.'],
                answer: 'Es una herramienta estrat√©gica para la toma de decisiones.'
            },
            {
                phase: 'Fase 7: El Legado üèÖ',
                title: 'M√≥dulo 21: ¬°Felicidades! Tu Certificado',
                emoji: 'üéì',
                content: `
                    <h2 class="text-3xl font-bold neon-text text-cyan-400 mb-4">¬°Guau! ¬°Lo Lograste! üêæüéì</h2>
                    <p class="text-xl mb-6">
                        ¬°Felicidades, <span id="final-dog-name" class="font-bold text-pink-400"></span>! Has completado el curso y te has ganado el prestigioso t√≠tulo de Sabueso de Datos Pol√≠ticos. ¬°Puppy Chiquito Pol√≠tico est√° orgulloso!
                    </p>
                    <div class="mt-8 fade-in">
                        <h3 class="text-xl font-bold text-cyan-300 mb-4">Tu Certificado de Logro</h3>
                        <canvas id="certificate-canvas" class="w-full h-auto bg-gray-800 rounded-lg neon-border"></canvas>
                        <p class="mt-4 text-gray-500 italic">Haz una captura de pantalla para guardar tu certificado.</p>
                        <p class="mt-8 text-lg font-bold text-fuchsia-400 text-center">
                            ¬°La victoria es tuya! üéâ Tu dedicaci√≥n y tu olfato para los datos hicieron la diferencia. Recuerda que con las herramientas adecuadas y un poco de instinto, puedes cambiar el mundo. ¬°El futuro es brillante para ti y para el Partido PUP! üêï
                        </p>
                    </div>
                `,
                type: 'certificate',
                question: null,
                answer: null
            }
        ];

        // Referencias a elementos del DOM
        const introScreen = document.getElementById('intro-screen');
        const courseScreen = document.getElementById('course-screen');
        const startForm = document.getElementById('start-form');
        const sidebarModules = document.getElementById('sidebar-modules');
        const courseTitleEl = document.getElementById('course-title');
        const moduleContainer = document.getElementById('module-container');
        const finalDogNameEl = document.getElementById('final-dog-name');
        const aiAssistantButton = document.getElementById('ai-assistant-button');
        const chatModal = document.getElementById('chat-modal');
        const closeChatButton = document.getElementById('close-chat-button');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendChatButton = document.getElementById('send-chat-button');
        const certificateCanvas = document.getElementById('certificate-canvas');

        // Funci√≥n para mostrar la pantalla
        function showScreen(screen) {
            introScreen.style.display = 'none';
            courseScreen.style.display = 'none';
            screen.style.display = 'flex';
        }

        // Cargar progreso
        function loadProgress() {
            const savedState = JSON.parse(localStorage.getItem('courseState'));
            if (savedState) {
                currentModuleIndex = savedState.currentModuleIndex;
                userName = savedState.userName;
                fullName = savedState.fullName;
                completedModules = savedState.completedModules || [];
                score = savedState.score || 0;
            }
        }

        // Guardar progreso
        function saveProgress() {
            const state = {
                currentModuleIndex,
                userName,
                fullName,
                completedModules,
                score
            };
            localStorage.setItem('courseState', JSON.stringify(state));
        }

        // Actualizar barra de progreso
        function updateProgressBar() {
            const totalModules = modules.length - 1; // Excluye m√≥dulo de certificado (20 m√≥dulos de avance)
            const completedCount = completedModules.filter(index => index < totalModules).length;
            const percent = Math.floor((completedCount / totalModules) * 100);
            
            const progressIndicator = document.getElementById('progress-indicator');
            const progressPercentage = document.getElementById('progress-percentage');
            
            if (progressIndicator) progressIndicator.style.width = `${percent}%`;
            if (progressPercentage) progressPercentage.textContent = `${percent}%`;
        }

        // Renderizar la barra lateral
        function renderSidebar() {
            sidebarModules.innerHTML = '';
            modules.forEach((mod, index) => {
                const isCompleted = completedModules.includes(index) || index === 0;
                const isActive = index === currentModuleIndex;

                const item = document.createElement('div');
                item.className = `sidebar-item cursor-pointer ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : 'opacity-50'}`;
                item.innerHTML = `<span class="text-xl mr-2">${mod.emoji}</span> ${mod.title}`;
                
                if (completedModules.includes(index) || index === 0) {
                    item.addEventListener('click', () => {
                        currentModuleIndex = index;
                        renderModule();
                    });
                }
                
                sidebarModules.appendChild(item);
            });
        }

        // Renderizar m√≥dulo
        function renderModule() {
            saveProgress();
            renderSidebar();
            updateProgressBar();

            const module = modules[currentModuleIndex];
            courseTitleEl.textContent = module.title;

            if (module.type === 'certificate') {
                moduleContainer.innerHTML = module.content;
                const finalDogNameEl = document.getElementById('final-dog-name');
                if (finalDogNameEl) finalDogNameEl.textContent = userName;
                isFinalModule = true;
                drawCertificate(fullName, Math.floor((score / (modules.length - 1)) * 100));
                return;
            } else {
                isFinalModule = false;
            }

            moduleContainer.innerHTML = `
                <div class="p-8 rounded-xl module-card">
                    ${module.content}
                </div>
                <div id="question-area" class="mt-8 p-6 rounded-xl module-card">
                    <h4 class="text-xl font-bold text-cyan-300 mb-4">${module.question}</h4>
                    <div id="question-content"></div>
                    <button id="check-answer-button" class="mt-6 py-3 px-6 text-lg font-bold rounded-lg text-white transition-all duration-300 bg-gradient-to-r from-teal-500 to-cyan-500 hover:from-teal-600 hover:to-cyan-600">
                        Comprobar Respuesta
                    </button>
                    <div id="feedback" class="mt-4 font-bold"></div>
                </div>
            `;

            const questionContent = document.getElementById('question-content');
            const checkAnswerButton = document.getElementById('check-answer-button');
            const feedbackEl = document.getElementById('feedback');

            if (module.type === 'multipleChoice') {
                module.options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.className = 'w-full text-left p-3 rounded-lg mb-2 bg-gray-700 hover:bg-gray-600 transition-colors duration-200';
                    button.addEventListener('click', () => {
                        const allButtons = questionContent.querySelectorAll('button');
                        allButtons.forEach(btn => btn.classList.remove('border-2', 'border-cyan-400'));
                        button.classList.add('border-2', 'border-cyan-400');
                        checkAnswerButton.disabled = false;
                        checkAnswerButton.dataset.answer = option;
                    });
                    questionContent.appendChild(button);
                });
                checkAnswerButton.dataset.correctAnswer = module.answer;
            } else if (module.type === 'shortAnswer') {
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = 'Escribe tu respuesta aqu√≠...';
                input.className = 'w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:border-cyan-500';
                questionContent.appendChild(input);
            } else if (module.type === 'dragAndDrop') {
                // Shuffle drag items for better interactivity
                const shuffledItems = shuffleArray([...module.dragItems]);
                questionContent.innerHTML = `
                    <div class="flex flex-col md:flex-row justify-around">
                        <div id="drag-items" class="flex flex-col items-center space-y-4 mb-8 md:mb-0">
                            ${shuffledItems.map(item => `
                                <div id="${item.id}" draggable="true" class="draggable w-56 h-12 flex items-center justify-center p-4 bg-purple-600 text-white rounded-lg cursor-grab">
                                    ${item.text}
                                </div>
                            `).join('')}
                        </div>
                        <div id="drop-targets" class="flex flex-col items-center space-y-4">
                            ${module.dropTargets.map(target => `
                                <div id="${target.id}" class="dropzone p-4 bg-gray-800 text-gray-400 rounded-lg w-56 h-12">
                                    ${target.text}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                setupDragAndDrop(module.correctMapping);
            }

            checkAnswerButton.onclick = () => checkAnswer();
            checkAnswerButton.style.display = 'block';
        }

        // Shuffle function
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Configurar drag and drop
        function setupDragAndDrop(correctMapping) {
            const draggables = document.querySelectorAll('.draggable');
            const dropzones = document.querySelectorAll('.dropzone');

            draggables.forEach(draggable => {
                draggable.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.id);
                    e.target.style.transform = 'scale(1.1)';
                });
                draggable.addEventListener('dragend', (e) => {
                    e.target.style.transform = 'scale(1)';
                });
            });

            dropzones.forEach(dropzone => {
                dropzone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropzone.classList.add('hovered');
                });
                dropzone.addEventListener('dragleave', () => {
                    dropzone.classList.remove('hovered');
                });
                dropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('hovered');
                    const draggableId = e.dataTransfer.getData('text/plain');
                    const draggableEl = document.getElementById(draggableId);
                    
                    if (draggableEl) {
                         // Check for existing child and validate
                        if (dropzone.firstElementChild) {
                            dropzone.firstElementChild.style.display = 'block';
                        }
                        dropzone.appendChild(draggableEl);
                        draggableEl.style.display = 'flex';
                        draggableEl.style.transform = 'scale(1)';
                        
                        // Immediate visual feedback
                        if (correctMapping[draggableId] === dropzone.id) {
                            dropzone.classList.add('drag-correct');
                            dropzone.classList.remove('drag-incorrect');
                        } else {
                            dropzone.classList.add('drag-incorrect');
                            dropzone.classList.remove('drag-correct');
                        }
                    }
                });
            });
        }

        // Comprobar la respuesta
        function checkAnswer() {
            const module = modules[currentModuleIndex];
            let isCorrect = false;
            let userAnswer;
            const feedbackEl = document.getElementById('feedback');

            // 1. Determinar si es correcta
            if (module.type === 'multipleChoice') {
                userAnswer = document.querySelector('#question-content button.border-cyan-400')?.textContent;
                if (userAnswer === module.answer) {
                    isCorrect = true;
                }
            } else if (module.type === 'shortAnswer') {
                userAnswer = document.getElementById('question-content').querySelector('input').value.trim();
                const cleanUserAnswer = userAnswer.toLowerCase().replace(/[.,!?¬°¬ø]/g, '');
                const cleanCorrectAnswer = module.answer.toLowerCase().replace(/[.,!?¬°¬ø]/g, '');
                if (cleanUserAnswer.includes(cleanCorrectAnswer)) {
                    isCorrect = true;
                }
            } else if (module.type === 'dragAndDrop') {
                isCorrect = true;
                for (const dragId in module.correctMapping) {
                    const dropzoneId = module.correctMapping[dragId];
                    const dropzoneEl = document.getElementById(dropzoneId);
                    if (!dropzoneEl || dropzoneEl.firstElementChild?.id !== dragId) {
                        isCorrect = false;
                        break;
                    }
                }
            }

            // 2. Dar retroalimentaci√≥n y avanzar si es correcta
            if (isCorrect) {
                feedbackEl.textContent = '¬°Correcto! ¬°Guau-maravilloso! üêæ'; 
                feedbackEl.className = 'mt-4 font-bold text-green-400';
                
                if (!completedModules.includes(currentModuleIndex)) {
                    score += 1;
                    completedModules.push(currentModuleIndex);
                }
                updateProgressBar(); // Actualizar barra inmediatamente

                // Auto-advance logic with a slight delay for smooth transition (800ms)
                setTimeout(() => {
                    if (currentModuleIndex < modules.length - 1) {
                        currentModuleIndex++;
                        renderModule();
                    } else if (currentModuleIndex === modules.length - 1) {
                        // Si ya estamos en el √∫ltimo m√≥dulo (Certificado), renderizarlo nuevamente
                        renderModule();
                    }
                }, 800); 
                
            } else {
                feedbackEl.textContent = '¬°Incorrecto! No te rindas, intenta de nuevo. ¬°Los grandes sabuesos tambi√©n se equivocan! üßê';
                feedbackEl.className = 'mt-4 font-bold text-red-400';
            }
        }
        
        // Dibujar certificado
        function drawCertificate(name, score) {
            const canvas = document.getElementById('certificate-canvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            canvas.width = 1200;
            canvas.height = 800;

            ctx.fillStyle = '#1e293b';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.font = 'bold 60px Inter';
            ctx.textAlign = 'center';
            ctx.fillStyle = '#10b981';
            ctx.shadowColor = '#06b6d4';
            ctx.shadowBlur = 10;
            ctx.fillText('¬°CERTIFICADO DE SABUESO!', canvas.width / 2, 200);

            ctx.font = '40px Inter';
            ctx.fillStyle = '#f43f5e';
            ctx.fillText('Este certificado es otorgado a:', canvas.width / 2, 300);

            ctx.font = 'bold 80px Inter';
            ctx.fillStyle = '#fff';
            ctx.fillText(name, canvas.width / 2, 400);

            ctx.font = '40px Inter';
            ctx.fillStyle = '#d1d5db';
            ctx.fillText('Por haber completado el curso de', canvas.width / 2, 500);

            ctx.font = 'bold 50px Inter';
            ctx.fillStyle = '#8b5cf6';
            ctx.fillText('An√°lisis de Datos Pol√≠ticos', canvas.width / 2, 560);

            ctx.font = '40px Inter';
            ctx.fillStyle = '#d1d5db';
            ctx.fillText(`Con una calificaci√≥n de ${score}%`, canvas.width / 2, 650);

            canvas.classList.add('fade-in');
        }

        // L√≥gica de inicio
        startForm.addEventListener('submit', (e) => {
            e.preventDefault();
            userName = document.getElementById('dog-name').value;
            fullName = document.getElementById('full-name').value;
            saveProgress();
            showScreen(courseScreen);
            renderModule();
        });

        // L√≥gica del chat
        aiAssistantButton.addEventListener('click', () => {
            chatModal.style.display = 'flex';
        });

        closeChatButton.addEventListener('click', () => {
            chatModal.style.display = 'none';
        });

        sendChatButton.addEventListener('click', async () => {
            const userMessage = chatInput.value;
            if (!userMessage.trim()) return;

            // Mostrar el mensaje del usuario
            addMessageToChat('user', userMessage);
            chatInput.value = '';

            // Mostrar "escribiendo..."
            addMessageToChat('bot', '...', true);

            try {
                const payload = {
                    contents: [{ parts: [{ text: `Act√∫a como un asistente de campa√±a perruno y responde con un tono divertido y con analog√≠as de perros. Pregunta del usuario: ${userMessage}` }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: "Eres un asistente de IA perruno, divertido y experto en an√°lisis de datos para campa√±as pol√≠ticas. Mant√©n el tono tem√°tico." }]
                    },
                };
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const botResponse = result.candidates?.[0]?.content?.parts?.[0]?.text || 'Guau, algo sali√≥ mal. Int√©ntalo de nuevo.';

                // Eliminar el mensaje de "escribiendo..." y mostrar la respuesta
                chatMessages.removeChild(chatMessages.lastElementChild);
                addMessageToChat('bot', botResponse);
            } catch (error) {
                console.error('Error with Gemini API:', error);
                chatMessages.removeChild(chatMessages.lastElementChild);
                addMessageToChat('bot', '¬°Guau! No puedo encontrar la respuesta en este momento. La conexi√≥n con la manada se perdi√≥. üì°');
            }
        });

        function addMessageToChat(sender, message, isTyping = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-3 rounded-lg max-w-[80%] ${sender === 'user' ? 'bg-blue-600 self-end ml-auto' : 'bg-gray-700 self-start mr-auto'}`;
            messageDiv.textContent = message;
            if (isTyping) {
                messageDiv.classList.add('italic');
            }
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Inicio de la aplicaci√≥n
        window.onload = () => {
            loadProgress();
            if (userName && fullName) {
                showScreen(courseScreen);
                renderModule();
            } else {
                showScreen(introScreen);
            }
        };

    </script>
</body>
</html>
