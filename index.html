<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis de Datos para la Campa√±a de Puppy: Partido P.U.P.</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.0.3/src/css/icons.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: #434343; /* Gris oscuro para el texto */
        }
        .container {
            max-width: 1200px;
            min-height: 100vh;
            display: flex;
            background-color: #f0f4f8;
        }
        .sidebar {
            width: 300px;
            background-color: #fff;
            padding: 2rem;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .sidebar-item {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .sidebar-item:hover {
            background-color: #e2e8f0;
        }
        .sidebar-item.active {
            background-color: #f7a233;
            color: white;
            font-weight: 600;
        }
        .main-content {
            flex-grow: 1;
            padding: 2rem;
            background-color: #f0f4f8;
            position: relative;
        }
        .progress-bar {
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            margin-bottom: 2rem;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #f7a233;
            transition: width 0.5s ease-in-out;
        }
        .button-primary {
            background-color: #f7a233;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .button-primary:hover {
            background-color: #e0912d;
        }
        .button-secondary {
            background-color: #e2e8f0;
            color: #434343;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .button-secondary:hover {
            background-color: #cbd5e1;
        }
        .chat-widget {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 100;
        }
        .chat-button {
            background-color: #f7a233;
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .chat-button:hover {
            transform: scale(1.1);
        }
        .chat-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        .chat-content {
            background-color: white;
            width: 90%;
            max-width: 500px;
            height: 70%;
            border-radius: 1rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .chat-header {
            background-color: #f1f5f9;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-body {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
        }
        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.75rem;
        }
        .user-message {
            background-color: #f7a233;
            color: white;
            align-self: flex-end;
        }
        .ai-message {
            background-color: #e2e8f0;
            color: #434343;
            align-self: flex-start;
        }
        .chat-input {
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
        }
        .chat-input input {
            flex-grow: 1;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin-right: 0.5rem;
        }
        .chat-input button {
            background-color: #1e293b;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }
        .hidden {
            display: none;
        }
        .quiz-option {
            background-color: #fff;
            border: 2px solid #cbd5e1;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quiz-option:hover {
            border-color: #f7a233;
            transform: translateY(-2px);
        }
        .quiz-option.selected {
            background-color: #f7a233;
            color: white;
            border-color: #f7a233;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

<div id="app" class="container">
    <div id="splash-screen" class="w-full text-center flex flex-col items-center justify-center">
        <h1 class="text-5xl font-extrabold mb-4 text-gray-800">¬°Bienvenido a la Campa√±a de Puppy! üê∂</h1>
        <p class="text-xl text-gray-600 mb-6">En el **Partido P.U.P. (Patitas Unidas por el Pueblo)**, estamos listos para conquistar los votos. ¬øTe unes a nuestro equipo de analistas de datos?</p>
        <div class="w-full max-w-sm">
            <input type="text" id="username-input" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 text-center" placeholder="Ingresa tu nombre perruno..."/>
            <button id="start-button" class="button-primary w-full text-xl py-3">¬°A mover la cola! üêæ</button>
        </div>
    </div>

    <div id="main-course" class="w-full flex hidden">
        <div class="sidebar">
            <h2 class="text-2xl font-bold mb-6">Mapa de Campa√±a üó∫Ô∏è</h2>
            <div id="sidebar-menu"></div>
        </div>

        <div class="main-content">
            <div id="progress-container" class="mb-8">
                <div class="flex justify-between items-center mb-2">
                    <span id="current-phase" class="font-semibold text-gray-600 text-sm"></span>
                    <span id="progress-percentage" class="font-semibold text-gray-600 text-sm">0%</span>
                </div>
                <div class="progress-bar">
                    <div id="progress-bar-fill" class="progress-bar-fill" style="width: 0%;"></div>
                </div>
            </div>

            <div id="module-display" class="bg-white p-8 rounded-xl shadow-lg">
                <h1 id="welcome-message" class="text-3xl font-bold mb-4"></h1>
                <h2 id="module-title" class="text-2xl font-semibold text-gray-700 mb-6"></h2>
                
                <div id="module-content"></div>

                <div id="quiz-section" class="mt-8 pt-4 border-t border-gray-200">
                    <p id="question-text" class="text-lg font-medium mb-4 text-gray-800"></p>
                    <div id="answer-options" class="flex flex-col"></div>
                    <input type="text" id="short-answer-input" class="w-full p-3 border-2 border-gray-300 rounded-lg hidden" placeholder="Escribe tu respuesta aqu√≠...">
                    <div id="feedback" class="mt-4 text-center font-bold hidden"></div>
                    <button id="submit-button" class="button-primary mt-6 w-full text-lg">Comprobar y avanzar ‚û°Ô∏è</button>
                </div>
            </div>

            <div id="conclusion" class="hidden text-center bg-white p-10 rounded-xl shadow-lg mt-8">
                <h2 class="text-4xl font-bold text-green-600 mb-4">¬°Guau! ¬°Lo lograste! üéâ</h2>
                <p class="text-xl mb-4 text-gray-700">Has completado tu entrenamiento para la campa√±a del **Partido P.U.P.** ¬°Ahora eres un analista de datos de √©lite, listo para ayudar a Puppy a ganar!</p>
                <p class="text-xl text-gray-700 mb-6">El futuro de la campa√±a est√° en tus manos. ¬°Usa tus nuevas habilidades para analizar, visualizar y conquistar los votos! üêæ</p>
                <button id="restart-button" class="button-secondary text-lg">Reiniciar Curso</button>
            </div>
        </div>
    </div>
</div>

<div id="chat-widget" class="chat-widget">
    <button id="chat-button" class="chat-button">
        <i class="ph-paw-print text-3xl"></i>
    </button>
</div>

<div id="chat-modal" class="chat-modal hidden">
    <div class="chat-content">
        <div class="chat-header">
            <h3 class="text-xl font-bold text-gray-800">Asistente de Campa√±a üê∂</h3>
            <button id="close-chat-button" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
        </div>
        <div id="chat-body" class="chat-body">
            <div class="message ai-message">¬°Guau! Soy tu asistente de campa√±a del **Partido P.U.P.**, acr√≥nimo de **"Patitas Unidas por el Pueblo"**. ¬øEn qu√© puedo ayudarte? Pregunta sobre el curso.</div>
        </div>
        <div class="chat-input">
            <input type="text" id="chat-input" placeholder="Pregunta al asistente..." />
            <button id="send-chat-button">
                <i class="ph-paper-plane-right text-white text-lg"></i>
            </button>
        </div>
    </div>
</div>

<script>
    const GEMINI_API_KEY = "AIzaSyAisbDrYyve2jOmoXuSYbNKu5Z5FNSlB3E";

    const COURSE_CONTENT = {
        "Fase 1: El Perro Sabio üê∂": [
            {
                title: "M√≥dulo 1: Limpieza de Datos üßπ",
                content: `
                    <p class="mb-4">¬°Hora de la primera tarea! La campa√±a de Puppy Chiquito Pol√≠tico del **Partido P.U.P.** tiene una lista de votantes un poco desordenada. Tu primera misi√≥n es limpiar los datos para que sean √∫tiles. Es como si Puppy se sacudiera el lodo despu√©s de jugar en el parque.</p>
                    <h3 class="font-bold text-lg mb-2 text-gray-800">Actividad: ¬°A sacudirse el lodo! üêæ</h3>
                    <p class="mb-2">Abre la hoja de c√°lculo de Google Sheets: <a href="https://docs.google.com/spreadsheets/d/12jt1jKI8Z7yDKU1LZnEX0gM1eyUqK-Y7fbeswfUNoMA/edit#gid=0" target="_blank" class="text-blue-500 hover:underline font-semibold">Haz clic aqu√≠ para abrir la hoja de datos</a>.</p>
                    <ul class="list-disc list-inside space-y-2 text-gray-700 mb-4">
                        <li>1. **Eliminar duplicados:** En la hoja de c√°lculo, selecciona todas las columnas. Ve a la barra de men√∫, haz clic en **"Datos"**, luego en **"Limpieza de datos"** y finalmente **"Quitar duplicados"**.</li>
                        <li>2. **Buscar y reemplazar:** A√∫n con la hoja seleccionada, usa el atajo **`Ctrl + H`** (o `Cmd + H` en Mac). En el campo "Buscar", escribe "Mora". En el campo "Reemplazar con", escribe "Morena". Haz clic en "Reemplazar todo". Esto es como ense√±arle a Puppy a no ladrarle a los carteros.</li>
                    </ul>
                    <div class="mt-6 p-4 bg-gray-100 rounded-lg border border-gray-200">
                        <p class="text-sm text-gray-600 italic">**Dato √∫til:** En Google Sheets, el "Voto de Encuesta" y el "Comentarios de Encuesta" solo nos dicen la intenci√≥n de voto, no el voto real. ¬°Los datos son nuestros mejores amigos!</p>
                    </div>
                `,
                question: "Despu√©s de la limpieza de datos, ¬øcu√°ntos votantes √∫nicos te quedan en total?",
                type: "short-answer",
                answer: "217",
                resources: "https://docs.google.com/spreadsheets/d/12jt1jKI8Z7yDKU1LZnEX0gM1eyUqK-Y7fbeswfUNoMA/edit#gid=0"
            },
            {
                title: "M√≥dulo 2: Segmentaci√≥n de Datos üìä",
                content: `
                    <p class="mb-4">Un buen analista sabe que no todos los votantes son iguales. Ahora que los datos est√°n limpios, es momento de clasificarlos por categor√≠as. Es como si Puppy distinguiera a los due√±os que le dan premios de los que solo le dan un abrazo.</p>
                    <h3 class="font-bold text-lg mb-2 text-gray-800">Actividad: ¬°A contar las patitas! üêï</h3>
                    <p class="mb-2">Abre tu hoja de c√°lculo y sigue estos pasos:</p>
                    <ul class="list-disc list-inside space-y-2 text-gray-700 mb-4">
                        <li>1. **Crea una nueva columna:** Inserta una columna a un lado de la columna "Edad" y n√≥mbrala **"Grupo de Edad"**.</li>
                        <li>2. **Clasifica a los votantes:** Usa la f√≥rmula `SI.CONJUNTO` para clasificar a cada votante. Copia y pega esta f√≥rmula en la primera celda de tu nueva columna (despu√©s del encabezado) y arr√°strala hacia abajo:
                        <pre class="bg-gray-100 p-3 rounded-md text-sm my-2">`=SI.CONJUNTO(E2<35, "Joven", E2<60, "Adulto", VERDADERO, "Veterano")`</pre>
                        Esto agrupa a los votantes en **"J√≥venes"** (menores de 35), **"Adultos"** (de 35 a 59), y **"Veteranos"** (60 o m√°s).</li>
                        <li>3. **Cuenta los grupos:** En una celda aparte, usa la funci√≥n `CONTAR.SI` para contar cu√°ntos votantes hay en cada grupo de edad. Por ejemplo:
                        <pre class="bg-gray-100 p-3 rounded-md text-sm my-2">`=CONTAR.SI(F:F, "Joven")`</pre></li>
                    </ul>
                `,
                question: "Seg√∫n tu segmentaci√≥n, ¬øcu√°ntos votantes 'Adultos' hay en la lista?",
                type: "short-answer",
                answer: "103"
            }
        ],
        "Fase 2: El Cart√≥grafo de Datos üó∫Ô∏è": [
            {
                title: "M√≥dulo 3: El Poder de VLOOKUP y QUERY üîç",
                content: `
                    <p class="mb-4">Para encontrar el votante perfecto para Puppy, necesitamos cruzar informaci√≥n. Esto es como buscar tu juguete favorito en el jard√≠n, usando el olfato y la vista al mismo tiempo.</p>
                    <h3 class="font-bold text-lg mb-2 text-gray-800">Actividad: ¬°Encuentra el hueso! ü¶¥</h3>
                    <p class="mb-2">Abre la hoja de c√°lculo de Google Sheets. Usa la hoja "Votantes" y "Tipo de votante".</p>
                    <ul class="list-disc list-inside space-y-2 text-gray-700 mb-4">
                        <li>1. **Cruza los datos con `VLOOKUP`:** En la hoja "Votantes", crea una nueva columna llamada **"Tipo de Votante"**. En la primera celda, usa la f√≥rmula `BUSCARV` (o `VLOOKUP` en ingl√©s) para traer el "Tipo de votante" de la Hoja 2 ("Tipo de votante") basado en el `ID_Votante`.</li>
                        <li>2. **Filtra con `QUERY`:** En una hoja nueva, usa la funci√≥n `QUERY` para crear un filtro avanzado que muestre a todos los "J√≥venes" que viven en la colonia "La Roma" y que son "Indecisos". Tu f√≥rmula lucir√° algo as√≠:
                        <pre class="bg-gray-100 p-3 rounded-md text-sm my-2">`=QUERY(A:G, "SELECT * WHERE G = 'Joven' AND D = 'La Roma' AND C = 'Indeciso'")`</pre></li>
                    </ul>
                `,
                question: "Usando QUERY, ¬øcu√°ntos votantes 'J√≥venes' en 'La Roma' son 'Indecisos'?",
                type: "short-answer",
                answer: "5"
            }
        ],
        "Fase 3: El Visionario de la Campa√±a üß†": [
            {
                title: "M√≥dulo 4: Creaci√≥n de Paneles Interactivos üìä",
                content: `
                    <p class="mb-4">¬°Es hora de hacer que los datos de la campa√±a brillen! Los paneles de control son como un mapa del parque para Puppy, mostr√°ndole d√≥nde est√°n los mejores lugares para jugar.</p>
                    <h3 class="font-bold text-lg mb-2 text-gray-800">Actividad: ¬°A dibujar el mapa! üé®</h3>
                    <ul class="list-disc list-inside space-y-2 text-gray-700 mb-4">
                        <li>1. **Conecta los datos:** Ve a <a href="https://lookerstudio.google.com/" target="_blank" class="text-blue-500 hover:underline font-semibold">Google Looker Studio</a> y crea un nuevo informe en blanco. Selecciona **"Google Sheets"** como tu fuente de datos y elige tu hoja de c√°lculo de Puppy.</li>
                        <li>2. **Crea un gr√°fico de pastel:** Agrega un gr√°fico de pastel (Pie chart) que muestre la distribuci√≥n de votantes por **"Grupo de Edad"** (J√≥venes, Adultos, Veteranos).</li>
                        <li>3. **Crea un cuadro de mando:** A√±ade una tarjeta de puntuaci√≥n (Scorecard) que muestre el **"Recuento de Votantes"** totales.</li>
                        <li>4. **¬°Un mapa de calor!:** Agrega un mapa que muestre el recuento de votantes por cada **"Colonia"** para ver d√≥nde est√° el apoyo de Puppy.</li>
                    </ul>
                `,
                question: "En el gr√°fico que creaste en Looker Studio, ¬øqu√© porcentaje de los votantes totales son 'Veteranos'?",
                type: "short-answer",
                answer: "29%"
            }
        ]
    };

    let currentModuleIndex = 0;
    let username = "";
    const totalModules = Object.values(COURSE_CONTENT).flat().length;
    const moduleMap = {};
    Object.keys(COURSE_CONTENT).forEach(phase => {
        COURSE_CONTENT[phase].forEach(module => {
            moduleMap[module.title] = { phase: phase, module: module };
        });
    });

    const splashScreen = document.getElementById('splash-screen');
    const mainCourse = document.getElementById('main-course');
    const usernameInput = document.getElementById('username-input');
    const startButton = document.getElementById('start-button');
    const sidebarMenu = document.getElementById('sidebar-menu');
    const welcomeMessage = document.getElementById('welcome-message');
    const progressBarFill = document.getElementById('progress-bar-fill');
    const progressPercentage = document.getElementById('progress-percentage');
    const currentPhase = document.getElementById('current-phase');
    const moduleTitle = document.getElementById('module-title');
    const moduleContent = document.getElementById('module-content');
    const quizSection = document.getElementById('quiz-section');
    const questionText = document.getElementById('question-text');
    const answerOptions = document.getElementById('answer-options');
    const shortAnswerInput = document.getElementById('short-answer-input');
    const submitButton = document.getElementById('submit-button');
    const feedback = document.getElementById('feedback');
    const conclusionSection = document.getElementById('conclusion');
    const restartButton = document.getElementById('restart-button');

    const chatButton = document.getElementById('chat-button');
    const chatModal = document.getElementById('chat-modal');
    const closeChatButton = document.getElementById('close-chat-button');
    const chatBody = document.getElementById('chat-body');
    const chatInput = document.getElementById('chat-input');
    const sendChatButton = document.getElementById('send-chat-button');

    function saveProgress() {
        const progress = { moduleIndex: currentModuleIndex, username: username };
        localStorage.setItem('puppy_course_progress', JSON.stringify(progress));
    }

    function loadProgress() {
        const progress = localStorage.getItem('puppy_course_progress');
        if (progress) {
            const savedProgress = JSON.parse(progress);
            currentModuleIndex = savedProgress.moduleIndex;
            username = savedProgress.username;
            return true;
        }
        return false;
    }

    function updateProgressBar() {
        const progress = (currentModuleIndex / totalModules) * 100;
        progressBarFill.style.width = `${progress}%`;
        progressPercentage.textContent = `${Math.round(progress)}%`;
    }

    function renderModule(moduleIndex) {
        const allModules = Object.values(COURSE_CONTENT).flat();
        if (moduleIndex >= totalModules) {
            showConclusion();
            return;
        }

        currentModuleIndex = moduleIndex;
        const currentModule = allModules[currentModuleIndex];
        const currentPhaseTitle = Object.keys(COURSE_CONTENT).find(phase =>
            COURSE_CONTENT[phase].includes(currentModule)
        );

        welcomeMessage.innerHTML = `¬°Hola, ${username}! üêæ`;
        currentPhase.textContent = currentPhaseTitle;
        moduleTitle.textContent = currentModule.title;
        moduleContent.innerHTML = currentModule.content;
        questionText.textContent = currentModule.question;
        feedback.textContent = "";
        feedback.classList.add('hidden');
        submitButton.textContent = "Comprobar y avanzar ‚û°Ô∏è";

        shortAnswerInput.classList.remove('hidden');
        shortAnswerInput.value = '';
        answerOptions.innerHTML = '';
        
        updateSidebar();
        updateProgressBar();
        saveProgress();
    }

    function handleAnswer() {
        const allModules = Object.values(COURSE_CONTENT).flat();
        const currentModule = allModules[currentModuleIndex];
        let userAnswer = shortAnswerInput.value.trim().toLowerCase();
        const correctAnswer = currentModule.answer.trim().toLowerCase();

        if (userAnswer === correctAnswer) {
            feedback.textContent = "¬°Correcto! ¬°Guau! üêï";
            feedback.classList.remove('hidden');
            feedback.classList.remove('text-red-600');
            feedback.classList.add('text-green-600');
            setTimeout(() => {
                currentModuleIndex++;
                renderModule(currentModuleIndex);
            }, 1500);
        } else {
            feedback.textContent = "¬°Incorrecto! Vuelve a revisar tu respuesta. üßê";
            feedback.classList.remove('hidden');
            feedback.classList.remove('text-green-600');
            feedback.classList.add('text-red-600');
        }
    }

    function showConclusion() {
        mainCourse.classList.add('hidden');
        conclusionSection.classList.remove('hidden');
        localStorage.removeItem('puppy_course_progress');
        updateProgressBar();
    }

    function buildSidebar() {
        sidebarMenu.innerHTML = '';
        let moduleCounter = 0;
        Object.keys(COURSE_CONTENT).forEach(phase => {
            const phaseTitle = document.createElement('h3');
            phaseTitle.className = "text-xl font-bold mt-4 mb-2 text-gray-800";
            phaseTitle.textContent = phase;
            sidebarMenu.appendChild(phaseTitle);

            COURSE_CONTENT[phase].forEach(module => {
                const moduleItem = document.createElement('div');
                moduleItem.className = "sidebar-item";
                moduleItem.textContent = module.title;
                moduleItem.dataset.index = moduleCounter;
                moduleItem.addEventListener('click', () => {
                    renderModule(parseInt(moduleItem.dataset.index));
                });
                sidebarMenu.appendChild(moduleItem);
                moduleCounter++;
            });
        });
    }

    function updateSidebar() {
        const sidebarItems = document.querySelectorAll('.sidebar-item');
        sidebarItems.forEach((item, index) => {
            if (index <= currentModuleIndex) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
    }

    async function initGeminiChat() {
        if (!GEMINI_API_KEY) {
            console.error("API Key not found.");
            return;
        }
        try {
            const { GoogleGenerativeAI } = await import('https://cdn.jsdelivr.net/npm/@google/generative-ai');
            const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash-latest" });

            chatModal.classList.remove('hidden');
            
            async function handleGeminiQuery() {
                const userQuery = chatInput.value;
                if (!userQuery.trim()) return;

                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'message user-message';
                userMessageDiv.textContent = userQuery;
                chatBody.insertBefore(userMessageDiv, chatBody.firstChild);
                chatInput.value = '';

                try {
                    const prompt = `Eres el Asistente de Campa√±a de Puppy Chiquito Pol√≠tico, un adorable cachorro que quiere ser diputado en M√©xico. Perteneces al **Partido P.U.P.**, acr√≥nimo de **"Patitas Unidas por el Pueblo"**. Tu misi√≥n es responder preguntas sobre el curso de an√°lisis de datos de la campa√±a. Mant√©n un tono divertido y profesional. Usa analog√≠as perrunas siempre que puedas.
                    Contexto del curso: El curso ense√±a a usar Google Sheets y Looker Studio para limpiar datos, segmentar votantes y crear paneles de control. El material est√° en esta hoja de c√°lculo: https://docs.google.com/spreadsheets/d/12jt1jKI8Z7yDKU1LZnEX0gM1eyUqK-Y7fbeswfUNoMA/edit#gid=0.
                    Pregunta del usuario: "${userQuery}"`;
                    
                    const result = await model.generateContent(prompt);
                    const response = await result.response;
                    const text = response.text();

                    const aiMessageDiv = document.createElement('div');
                    aiMessageDiv.className = 'message ai-message';
                    aiMessageDiv.textContent = text;
                    chatBody.insertBefore(aiMessageDiv, chatBody.firstChild);
                } catch (error) {
                    console.error("Error al llamar a la API de Gemini:", error);
                    const errorMessageDiv = document.createElement('div');
                    errorMessageDiv.className = 'message ai-message';
                    errorMessageDiv.textContent = "¬°Guau! Hubo un error al comunicarme con la central de campa√±a. Intenta de nuevo m√°s tarde.";
                    chatBody.insertBefore(errorMessageDiv, chatBody.firstChild);
                }
            }

            sendChatButton.onclick = handleGeminiQuery;
            chatInput.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    handleGeminiQuery();
                }
            };
        } catch (error) {
            console.error("Error al cargar la biblioteca de Gemini:", error);
            alert("No se pudo iniciar el Asistente de IA. Por favor, revisa la consola de tu navegador.");
        }
    }

    function closeChat() {
        chatModal.classList.add('hidden');
        chatInput.value = '';
    }

    function startCourse() {
        const storedUsername = localStorage.getItem('puppy_course_username');
        if (storedUsername) {
            username = storedUsername;
            splashScreen.classList.add('hidden');
            mainCourse.classList.remove('hidden');
            buildSidebar();
            if (loadProgress()) {
                const allModules = Object.values(COURSE_CONTENT).flat();
                if (currentModuleIndex >= allModules.length) {
                    showConclusion();
                } else {
                    renderModule(currentModuleIndex);
                }
            } else {
                currentModuleIndex = 0;
                renderModule(currentModuleIndex);
            }
        } else {
            usernameInput.value = "";
            usernameInput.focus();
            splashScreen.classList.remove('hidden');
            mainCourse.classList.add('hidden');
        }
    }

    startButton.addEventListener('click', () => {
        username = usernameInput.value.trim();
        if (username) {
            localStorage.setItem('puppy_course_username', username);
            splashScreen.classList.add('hidden');
            mainCourse.classList.remove('hidden');
            buildSidebar();
            startCourse();
        } else {
            alert("¬°Por favor, ingresa tu nombre para empezar!");
        }
    });

    submitButton.addEventListener('click', handleAnswer);
    shortAnswerInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            handleAnswer();
        }
    });

    chatButton.addEventListener('click', initGeminiChat);
    closeChatButton.addEventListener('click', closeChat);
    restartButton.addEventListener('click', () => {
        localStorage.clear();
        window.location.reload();
    });

    document.addEventListener('DOMContentLoaded', startCourse);
</script>
</body>
</html>
