<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curso: El Sabueso de Datos PolÃ­ticos ğŸ¾</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0a09; /* Zinc-950 */
            color: #d1d5db; /* Gray-300 */
            overflow: hidden; /* Hide main body overflow */
        }
        .neon-border {
            border: 2px solid;
            border-image: linear-gradient(45deg, #10b981, #f43f5e, #8b5cf6, #06b6d4) 1;
            box-shadow: 0 0 15px #f43f5e, 0 0 30px #8b5cf6;
        }
        .neon-text {
            text-shadow: 0 0 5px #f43f5e, 0 0 10px #8b5cf6;
        }
        .module-card {
            background: rgba(15, 23, 42, 0.7); /* Slate-900 with transparency */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(51, 65, 85, 0.5); /* Slate-700 with transparency */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 10px 15px rgba(0, 0, 0, 0.2);
        }
        .progress-line {
            height: 2px;
            background-color: #4b5563;
        }
        .progress-line-completed {
            background-color: #10b981;
        }
        #chat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }
        .chat-content {
            background-color: #1f2937;
            border-radius: 1rem;
            border: 2px solid #3b82f6;
            box-shadow: 0 0 20px #3b82f6;
        }
        .draggable {
            cursor: grab;
            transition: transform 0.2s;
        }
        .draggable:active {
            cursor: grabbing;
        }
        .dropzone {
            min-height: 4rem;
            border: 2px dashed #64748b;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: all 0.2s;
        }
        .dropzone.hovered {
            background-color: rgba(100, 116, 139, 0.2);
            border-color: #3b82f6;
            border-style: solid;
        }
        /* Sidebar Styling */
        #sidebar {
            width: 250px;
            background: rgba(22, 28, 42, 0.9);
            border-right: 1px solid rgba(51, 65, 85, 0.5);
            padding: 1rem;
            overflow-y: auto;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 50;
        }
        #course-content-container {
            margin-left: 250px;
            padding: 2rem;
            height: 100vh;
            overflow-y: auto;
        }
        @media (max-width: 1024px) {
            #sidebar {
                position: relative;
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid rgba(51, 65, 85, 0.5);
            }
            #course-content-container {
                margin-left: 0;
                padding-top: 1rem;
            }
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease, transform 0.2s ease;
            cursor: pointer;
            color: #9ca3af;
        }
        .sidebar-item.completed {
            background-color: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }
        .sidebar-item.active {
            background-color: rgba(244, 63, 94, 0.1);
            color: #f43f5e;
            transform: scale(1.05);
        }
        .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        pre {
            background-color: #1e293b;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }

        /* Nueva animaciÃ³n para el botÃ³n del asistente */
        @keyframes bounce-animation {
            0%, 100% { transform: scale(1) translateY(0); }
            50% { transform: scale(1.1) translateY(-5px); }
        }
        .animate-bounce {
            animation: bounce-animation 2s infinite ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-300">

    <!-- Pantalla de Inicio -->
    <div id="intro-screen" class="w-full h-screen flex flex-col items-center justify-center p-8">
        <div class="w-full max-w-lg p-8 module-card rounded-xl">
            <div class="flex flex-col items-center text-center">
                <h1 class="text-4xl font-bold neon-text text-cyan-400 mb-4">Â¡Curso de Entrenamiento Canino PolÃ­tico! ğŸ¶</h1>
                <p class="mb-6 text-gray-400">
                    Â¡Bienvenido, futuro sabueso de datos! Puppy Chiquito PolÃ­tico necesita de tu ayuda para su campaÃ±a.
                    Antes de empezar a olfatear datos, necesitamos que nos des tu informaciÃ³n.
                </p>
                <form id="start-form" class="w-full space-y-4">
                    <div>
                        <label for="dog-name" class="block mb-2 text-sm font-medium text-cyan-300">Â¿CuÃ¡l es tu nombre perruno? ğŸ¾</label>
                        <input type="text" id="dog-name" placeholder="Ej: Fido El Audaz" required class="w-full p-3 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:border-cyan-500">
                    </div>
                    <div>
                        <label for="full-name" class="block mb-2 text-sm font-medium text-cyan-300">Tu nombre completo (para el certificado) ğŸ…</label>
                        <input type="text" id="full-name" placeholder="Ej: John Doe" required class="w-full p-3 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:border-cyan-500">
                    </div>
                    <button type="submit" class="w-full py-3 mt-4 text-lg font-bold rounded-lg text-white transition-all duration-300 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600">
                        Â¡A Cazar Datos! ğŸ•
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Pantalla del Curso con Sidebar -->
    <div id="course-screen" class="hidden lg:flex w-full h-screen">
        <!-- Sidebar de navegaciÃ³n -->
        <nav id="sidebar" class="w-1/4 max-w-xs flex flex-col">
            <h3 class="text-2xl font-bold neon-text text-cyan-400 mb-4">Temario ğŸ“œ</h3>
            <div id="sidebar-modules" class="flex-grow space-y-2"></div>
        </nav>
        
        <!-- Contenido principal del curso -->
        <main id="course-content-container" class="flex-grow">
            <h2 id="course-title" class="text-3xl font-bold neon-text text-cyan-400 mb-4 text-center"></h2>
            <div id="module-container" class="min-h-[500px]">
                <!-- Contenido del mÃ³dulo y preguntas se renderizarÃ¡n aquÃ­ -->
            </div>
            <button id="next-module-button" class="w-full py-3 mt-8 text-lg font-bold rounded-lg text-white transition-all duration-300 bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 hidden">
                Siguiente MÃ³dulo
            </button>
        </main>
    </div>

    <!-- BotÃ³n del Asistente de IA -->
    <button id="ai-assistant-button" class="fixed bottom-8 right-8 z-50 w-16 h-16 rounded-full bg-blue-500 flex items-center justify-center text-4xl shadow-lg hover:scale-110 transition-transform duration-300 cursor-pointer animate-bounce">
        ğŸ¶
    </button>

    <!-- Modal del Asistente de IA -->
    <div id="chat-modal" class="fixed inset-0 flex items-center justify-center p-4 z-[1000]">
        <div class="chat-content w-full max-w-md h-3/4 flex flex-col p-4 rounded-xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-cyan-300">Asistente de CampaÃ±a ğŸ•â€ğŸ¦º</h3>
                <button id="close-chat-button" class="text-gray-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <div id="chat-messages" class="flex-grow overflow-y-auto space-y-4 p-2 bg-gray-800 rounded-lg mb-4">
                <div class="text-center text-gray-400 italic">Â¡Guau! Estoy listo para ayudarte. Â¿En quÃ© tienes dudas?</div>
            </div>
            <div class="flex">
                <input type="text" id="chat-input" placeholder="PregÃºntale al Asistente..." class="flex-grow p-3 rounded-l-lg bg-gray-700 text-white focus:outline-none border border-gray-600">
                <button id="send-chat-button" class="px-4 py-3 bg-blue-600 rounded-r-lg text-white hover:bg-blue-700 transition-colors duration-200">
                    Enviar
                </button>
            </div>
        </div>
    </div>

    <script>
        // ConfiguraciÃ³n de la API de Gemini y el curso
        const API_KEY = "AIzaSyAisbDrYyve2jOmoXuSYbNKu5Z5FNSlB3E";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const resourcesLink = "https://docs.google.com/spreadsheets/d/12jt1jKI8Z7yDKU1LZnEX0gM1eyUqK-Y7fbeswfUNoMA/edit?usp=sharing";

        // Estado de la aplicaciÃ³n
        let currentModuleIndex = 0;
        let userName = '';
        let fullName = '';
        let completedModules = [];
        let score = 0;
        let isFinalModule = false;

        // Contenido del curso
        const modules = [
            {
                phase: 'Fase 1: El Olfato AnalÃ­tico ğŸ¾',
                title: 'MÃ³dulo 1: Presentando a Puppy y su Partido PUP',
                emoji: 'ğŸ¶',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">Conoce a Puppy Chiquito PolÃ­tico y el Partido PUP</h3>
                    <p class="text-gray-400 mb-4">
                        Â¡Guau! Â¡Bienvenido, futuro sabueso de datos! Puppy Chiquito PolÃ­tico, un adorable cachorro mestizo de la CDMX, tiene un gran sueÃ±o: ser diputado para mejorar la vida de todos. . Su partido se llama **PUP: Patitas Unidas para el Pueblo**. ğŸ¾ Juntos, vamos a usar el poder de los datos para ganar la elecciÃ³n. Â¡Tu primera misiÃ³n es aprender a olfatear los datos correctos!
                    </p>
                `,
                type: 'multipleChoice',
                question: 'Â¿CuÃ¡l es el nombre del partido de Puppy Chiquito PolÃ­tico?',
                options: ['Perros Unidos Partidarios', 'Patitas Unidas para el Pueblo', 'Perros Urbanos y Patriotas'],
                answer: 'Patitas Unidas para el Pueblo'
            },
            {
                phase: 'Fase 1: El Olfato AnalÃ­tico ğŸ¾',
                title: 'MÃ³dulo 2: El Recinto Canino: Tu primer Google Sheet',
                emoji: 'ğŸ“Š',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">MisiÃ³n: Â¡Preparar el Recinto Canino! ğŸ“Š</h3>
                    <p class="text-gray-400 mb-4">
                        Â¡La campaÃ±a ha empezado! El primer paso es organizar la informaciÃ³n de los votantes. La herramienta principal de nuestro equipo es Google Sheets. Piensa en ella como un gran parque lleno de datos, donde cada hoja es un Ã¡rea cercada y cada celda una huella. Â¡Es el lugar perfecto para organizar toda la informaciÃ³n de nuestros votantes! ğŸ¾
                    </p>
                    <p class="text-gray-400 mb-4">
                        Para esta actividad, dirÃ­gete al tazÃ³n de recursos y haz una copia para tu propio uso.
                    </p>
                    <div class="flex justify-center mt-6">
                        <a href="https://docs.google.com/spreadsheets/d/12jt1jKI8Z7yDKU1LZnEX0gM1eyUqK-Y7fbeswfUNoMA/edit?usp=sharing" target="_blank" class="py-3 px-6 text-lg font-bold rounded-lg text-white transition-all duration-300 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600">
                            Ir al TazÃ³n de Recursos ğŸ¾
                        </a>
                    </div>
                `,
                type: 'multipleChoice',
                question: 'En el tazÃ³n de recursos, Â¿quÃ© columna representa el tipo de votante de acuerdo con su afinidad por perros o gatos?',
                options: ['Nombre_Completo', 'Tipo_Votante', 'Voto_Encuesta'],
                answer: 'Tipo_Votante'
            },
            {
                phase: 'Fase 1: El Olfato AnalÃ­tico ğŸ¾',
                title: 'MÃ³dulo 3: La Pista de Huellas: Datos Sucios vs. Limpios',
                emoji: 'ğŸ”',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">MisiÃ³n: Â¡Olfatea la suciedad! ğŸ”</h3>
                    <p class="text-gray-400 mb-4">
                        Al recolectar la informaciÃ³n, algunas huellas (los datos) estÃ¡n llenas de barro: nombres mal escritos, edades que no tienen sentido, campos vacÃ­os. Esto es lo que llamamos "datos sucios". Nuestro trabajo como sabuesos es limpiar este barro para que el camino sea claro. ğŸ§¼
                    </p>
                    <p class="text-gray-400">
                        Mira los datos que tenemos. La limpieza es el primer paso.
                    </p>
                `,
                type: 'dragAndDrop',
                question: 'Â¡Guau! Arrastra la tarjeta que representa un "dato sucio" y "dato limpio" basado en el tipo de votante de nuestra tabla.',
                dragItems: [
                    { id: 'item-1', text: 'Amante de gatos' },
                    { id: 'item-2', text: 'amantedegatos' }
                ],
                dropTargets: [
                    { id: 'target-1', text: 'Dato Limpio âœ¨' },
                    { id: 'target-2', text: 'Dato Sucio ğŸ’©' }
                ],
                correctMapping: {
                    'item-1': 'target-1',
                    'item-2': 'target-2'
                }
            },
            {
                phase: 'Fase 2: Estrategia de Manada ğŸ¶',
                title: 'MÃ³dulo 4: El Rastreador GPS: Usando BUSCARX',
                emoji: 'ğŸ“',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">MisiÃ³n: Â¡No mÃ¡s vueltas en cÃ­rculos! ğŸ—ºï¸</h3>
                    <p class="text-gray-400 mb-4">
                        Puppy quiere mandarle un huesito personalizado a un votante con "ID_Votante" **V004**, pero necesita su colonia. Con la funciÃ³n **=BUSCARX()**, podemos encontrar cualquier dato sin importar dÃ³nde estÃ©. Es nuestro rastreador GPS para los votantes. Es mÃ¡s poderosa y flexible que BUSCARV y BUSCARH. Es ideal para encontrar un dato de forma precisa y rÃ¡pida.
                    </p>
                    <p class="text-gray-400 mb-4">
                        Su sintaxis es simple: **=BUSCARX(lo_que_buscas, rango_donde_buscar, rango_donde_devolver)**
                    </p>
                `,
                type: 'multipleChoice',
                question: 'Si Puppy quiere saber en quÃ© colonia vive el votante con "ID_Votante" V004, Â¿quÃ© fÃ³rmula usarÃ­as?',
                options: ['=BUSCARV("V004", A:D, 4, FALSO)', '=BUSCARX("V004", A:A, D:D)', '=BUSCARX("V004", D:D, A:A)'],
                answer: '=BUSCARX("V004", A:A, D:D)'
            },
            {
                phase: 'Fase 2: Estrategia de Manada ğŸ¶',
                title: 'MÃ³dulo 5: El Olfato de Grupo: Filtrando datos con FILTER',
                emoji: 'ğŸ‘ƒ',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">MisiÃ³n: Â¡Olfateando solo a los importantes! ğŸ‘ƒ</h3>
                    <p class="text-gray-400 mb-4">
                        Puppy planea un evento en el Parque MÃ©xico y solo necesita la lista de votantes de la colonia **Condesa**. Con la funciÃ³n **=FILTER()**, podemos crear una lista de votantes que cumplan con un criterio especÃ­fico. Es como separar a los cachorros de los perros adultos para un juego. ğŸ•â€ğŸ¦º
                    </p>
                    <p class="text-gray-400 mb-4">
                        La sintaxis es: **=FILTER(rango_a_filtrar, condiciÃ³n1, [condiciÃ³n2, ...])**.
                    </p>
                `,
                type: 'multipleChoice',
                question: 'Â¿QuÃ© fÃ³rmula usarÃ­as para crear una nueva tabla solo con los votantes de la colonia "Condesa"?',
                options: ['=FILTRAR(A:E, D:D="Condesa")', '=BUSCARX(A:E, D:D="Condesa")', '=BUSCARV(D:D="Condesa")'],
                answer: '=FILTRAR(A:E, D:D="Condesa")'
            },
            {
                phase: 'Fase 2: Estrategia de Manada ğŸ¶',
                title: 'MÃ³dulo 6: El Ladrido de Prioridad: Valores Booleanos',
                emoji: 'ğŸš¨',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">MisiÃ³n: Â¿QuiÃ©n necesita mÃ¡s atenciÃ³n? ğŸš¨</h3>
                    <p class="text-gray-400 mb-4">
                        Para la campaÃ±a, necesitamos identificar a los votantes indecisos de las colonias clave. Un valor booleano (**VERDADERO** o **FALSO**) nos ayuda a saber si un votante cumple con mÃºltiples condiciones. Es la forma mÃ¡s rÃ¡pida de decir "Â¡sÃ­, este votante es importante!" o "Â¡no, este votante no es una prioridad ahora!". ğŸ¾
                    </p>
                    <p class="text-gray-400 mb-4">
                        Las funciones clave son **=Y()** para que todas las condiciones sean VERDADERO, y **=O()** para que al menos una sea VERDADERO.
                    </p>
                `,
                type: 'multipleChoice',
                question: 'Â¿QuÃ© fÃ³rmula usarÃ­as para marcar con VERDADERO a los votantes que son "Indeciso" Y de la colonia "La Roma"?',
                options: ['=Y(C2="Indeciso", D2="La Roma")', '=O(C2="Indeciso", D2="La Roma")', '=SI(C2="Indeciso")'],
                answer: '=Y(C2="Indeciso", D2="La Roma")'
            },
            {
                phase: 'Fase 2: Estrategia de Manada ğŸ¶',
                title: 'MÃ³dulo 7: Conectando Datos con LÃ³gica: La CacerÃ­a Perfecta',
                emoji: 'ğŸ”—',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">MisiÃ³n: Â¡La cacerÃ­a perfecta! ğŸ¯</h3>
                    <p class="text-gray-400 mb-4">
                        Â¡El equipo de campaÃ±a descubriÃ³ un problema! Muchos votantes en La Roma han mencionado la palabra "trÃ¡fico" en sus comentarios. Puppy necesita saber exactamente quiÃ©nes son para poder hacerles llegar un mensaje especial sobre sus propuestas para mejorar la movilidad. Â¡Tu misiÃ³n es usar tus habilidades de sabueso para crear esa lista! ğŸ•â€ğŸ¦º
                    </p>
                `,
                type: 'dragAndDrop',
                question: 'Arrastra las funciones para crear la fÃ³rmula que filtra a los votantes que mencionan "trÃ¡fico" en sus comentarios.',
                dragItems: [
                    { id: 'item-1', text: 'FILTER(' },
                    { id: 'item-2', text: 'F:F' },
                    { id: 'item-3', text: 'BUSCAR("trÃ¡fico", F:F))' }
                ],
                dropTargets: [
                    { id: 'target-1', text: '=FILTER(' },
                    { id: 'target-2', text: 'Rango a filtrar' },
                    { id: 'target-3', text: 'CondiciÃ³n' }
                ],
                correctMapping: {
                    'item-1': 'target-1',
                    'item-2': 'target-2',
                    'item-3': 'target-3'
                }
            },
            {
                phase: 'Fase 3: VisualizaciÃ³n de Terreno ğŸ—ºï¸',
                title: 'MÃ³dulo 8: El Resumen de la Manada: Tablas DinÃ¡micas',
                emoji: 'ğŸ“',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">MisiÃ³n: Â¿En quÃ© colonia tiene mÃ¡s aliados Puppy? ğŸ“Š</h3>
                    <p class="text-gray-400 mb-4">
                        El equipo de campaÃ±a necesita saber rÃ¡pidamente en quÃ© colonias tenemos mÃ¡s aliados para enfocar sus paseos. Contar manualmente serÃ­a un desastre. La soluciÃ³n es una **Tabla DinÃ¡mica**. Con ella, podemos resumir grandes cantidades de datos en una tabla fÃ¡cil de leer para tomar decisiones rÃ¡pidas. Â¡Es como contar cuÃ¡ntos perros de cada raza hay en un parque! ğŸ¾
                    </p>
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-amber-300 mb-2">Tabla DinÃ¡mica de Muestra:</h4>
                        <p class="text-gray-400 mb-2 italic">Puedes recrear esto en Google Sheets usando los datos del curso.</p>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-gray-400">
                                <thead class="text-xs uppercase bg-gray-700 text-gray-300">
                                    <tr>
                                        <th scope="col" class="py-3 px-6">Colonia</th>
                                        <th scope="col" class="py-3 px-6">Conteo de ID_Votante</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="bg-gray-800 border-b border-gray-700">
                                        <td class="py-4 px-6 font-medium text-white">La Roma</td>
                                        <td class="py-4 px-6">5</td>
                                    </tr>
                                    <tr class="bg-gray-800 border-b border-gray-700">
                                        <td class="py-4 px-6 font-medium text-white">Condesa</td>
                                        <td class="py-4 px-6">4</td>
                                    </tr>
                                    <tr class="bg-gray-800">
                                        <td class="py-4 px-6 font-medium text-white">Polanco</td>
                                        <td class="py-4 px-6">3</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `,
                type: 'multipleChoice',
                question: 'Para crear una Tabla DinÃ¡mica en Sheets, Â¿quÃ© campo pondrÃ­as en "Filas" para contar votantes por colonia?',
                options: ['Colonia', 'Nombre_Completo', 'Voto_Encuesta'],
                answer: 'Colonia'
            },
            {
                phase: 'Fase 3: VisualizaciÃ³n de Terreno ğŸ—ºï¸',
                title: 'MÃ³dulo 9: El Mapa de Votantes: GrÃ¡ficos de Resumen',
                emoji: 'ğŸ—ºï¸',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">MisiÃ³n: El camino de Puppy a la victoria. ğŸ“ˆ</h3>
                    <p class="text-gray-400 mb-4">
                        Gracias a tu Tabla DinÃ¡mica, Puppy sabe que "La Roma" y "Condesa" tienen muchos votantes. Para que el equipo lo entienda mejor, crea un grÃ¡fico de pastel. AsÃ­ podrÃ¡n visualizar rÃ¡pidamente el porcentaje de aliados por colonia y planificar su campaÃ±a. Â¡Un grÃ¡fico bien hecho vale mÃ¡s que mil ladridos! ğŸ¨
                    </p>
                    <div class="mt-8 flex justify-center items-center h-64 bg-gray-800 rounded-lg">
                        <div class="w-48 h-48 rounded-full shadow-lg" style="background: conic-gradient(red 0% 30%, blue 30% 60%, orange 60% 100%);"></div>
                    </div>
                `,
                type: 'multipleChoice',
                question: 'Una vez que tienes los datos resumidos en la Tabla DinÃ¡mica, Â¿quÃ© tipo de grÃ¡fico es ideal para mostrar la distribuciÃ³n de votantes por colonia?',
                options: ['GrÃ¡fico de barras', 'GrÃ¡fico de pastel', 'GrÃ¡fico de lÃ­neas'],
                answer: 'GrÃ¡fico de pastel'
            },
            {
                phase: 'Fase 3: VisualizaciÃ³n de Terreno ğŸ—ºï¸',
                title: 'MÃ³dulo 10: SemÃ¡foro de Prioridad: Formato Condicional',
                emoji: 'ğŸš¦',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">MisiÃ³n: Â¡Colorea lo mÃ¡s importante! ğŸš¥</h3>
                    <p class="text-gray-400 mb-4">
                        Ahora, Puppy necesita analizar la efectividad de sus visitas a las colonias. Vas a usar el **Formato Condicional** para que, en la columna "Voto_Encuesta", las celdas con "SÃ­" se pongan verdes, "No" se pongan rojas e "Indeciso" se pongan amarillas. Es como un semÃ¡foro de apoyo polÃ­tico.
                    </p>
                    <div class="mt-8 flex justify-center items-center">
                        <img src="https://placehold.co/600x200/292524/e7e5e4?text=Formato+Condicional+de+Ejemplo" alt="Ejemplo de Formato Condicional en Google Sheets" class="rounded-lg shadow-lg">
                    </div>
                `,
                type: 'dragAndDrop',
                question: 'Arrastra los colores al tipo de voto correcto para el Formato Condicional.',
                dragItems: [
                    { id: 'item-1', text: 'Verde' },
                    { id: 'item-2', text: 'Rojo' },
                    { id: 'item-3', text: 'Amarillo' }
                ],
                dropTargets: [
                    { id: 'target-1', text: '"SÃ­"' },
                    { id: 'target-2', text: '"No"' },
                    { id: 'target-3', text: '"Indeciso"' }
                ],
                correctMapping: {
                    'item-1': 'target-1',
                    'item-2': 'target-2',
                    'item-3': 'target-3'
                }
            },
            {
                phase: 'Fase 4: El Perro Robot ğŸ¤–',
                title: 'MÃ³dulo 11: La Pericia del Sabueso: AutomatizaciÃ³n',
                emoji: 'ğŸ¤–',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">MisiÃ³n: Â¡Deja que el perro haga el trabajo! âš™ï¸</h3>
                    <p class="text-gray-400 mb-4">
                        Un sabueso inteligente no persigue la misma ardilla todos los dÃ­as. La automatizaciÃ³n, usando Google App Script, nos permite enseÃ±ar a las hojas de cÃ¡lculo a hacer el trabajo repetitivo por nosotros. Podemos programar tareas como enviar correos, generar reportes o actualizar datos automÃ¡ticamente. Â¡Es como tener un perro robot que hace el trabajo por ti!
                    </p>
                `,
                type: 'multipleChoice',
                question: 'Â¿QuÃ© herramienta se utiliza para automatizar tareas en Google Sheets?',
                options: ['Google Forms', 'Google App Script', 'Google Docs'],
                answer: 'Google App Script'
            },
            {
                phase: 'Fase 4: El Perro Robot ğŸ¤–',
                title: 'MÃ³dulo 12: Escribiendo tu Primer Script con ayuda de IA ğŸ§¹',
                emoji: 'âŒ¨ï¸',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">MisiÃ³n: Â¡Una pata al cÃ³digo con IA! ğŸ¤–</h3>
                    <p class="text-gray-400 mb-4">
                        Puppy se da cuenta de que los nuevos datos de encuestas llegan con espacios extra y letras minÃºsculas en los nombres. Tu misiÃ³n es crear un script que limpie la columna **Nombre_Completo**.
                        <br>
                        En lugar de darte el cÃ³digo fijo, te mostraremos cÃ³mo usar una IA para que genere el cÃ³digo por ti. Â¡AsÃ­ es como los analistas modernos trabajan! Ve a **'Extensiones' > 'Apps Script'** en tu Google Sheet.
                    </p>
                    <p class="text-gray-400 mb-4">
                        Usa un prompt como este en una IA (como nuestro asistente o cualquier otra):
                        <pre><code>"Necesito un script en Google Apps Script para una hoja de cÃ¡lculo. El script debe limpiar los datos en la columna B, eliminando espacios al inicio y al final, y convirtiendo la primera letra de cada palabra a mayÃºscula. Debe procesar todas las filas con datos y sobrescribir los valores en su lugar."</code></pre>
                    </p>
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-purple-300 mb-2">RecreaciÃ³n de la interfaz de Apps Script:</h4>
                        <div class="bg-gray-900 rounded-lg p-4">
                            <div class="flex items-center space-x-2 text-sm text-gray-500 mb-2">
                                <span class="font-mono">Code.gs</span>
                            </div>
                            <pre class="bg-gray-900 text-green-300 overflow-x-auto"><code class="language-javascript">// CÃ³digo generado por IA...
function limpiarNombres() {
  var hoja = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var rango = hoja.getRange('B2:B' + hoja.getLastRow());
  var valores = rango.getValues();

  for (var i = 0; i < valores.length; i++) {
    var nombreLimpio = valores[i][0].toString().trim();
    var palabras = nombreLimpio.split(' ');
    for (var j = 0; j < palabras.length; j++) {
      if (palabras[j].length > 0) {
        palabras[j] = palabras[j].charAt(0).toUpperCase() + palabras[j].slice(1).toLowerCase();
      }
    }
    valores[i][0] = palabras.join(' ');
  }

  rango.setValues(valores);
}</code></pre>
                        </div>
                    </div>
                    <p class="text-gray-400 mt-4 italic">
                        Â¿Necesitas ayuda con el prompt o no funciona el cÃ³digo? Â¡PregÃºntale a nuestro asistente de IA integrado! ğŸ•â€ğŸ¦º
                    </p>
                `,
                type: 'multipleChoice',
                question: 'Â¿QuÃ© hace el mÃ©todo `.trim()` en un script de JavaScript?',
                options: ['Convierte el texto a mayÃºsculas.', 'Elimina los espacios al inicio y final del texto.', 'Cambia el color de la celda.'],
                answer: 'Elimina los espacios al inicio y final del texto.'
            },
            {
                phase: 'Fase 4: El Perro Robot ğŸ¤–',
                title: 'MÃ³dulo 13: La CampaÃ±a en Piloto AutomÃ¡tico',
                emoji: 'âš™ï¸',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">MisiÃ³n: Â¡Tareas automÃ¡ticas! âš™ï¸</h3>
                    <p class="text-gray-400 mb-4">
                        Para que el equipo de Puppy no tenga que correr el script cada vez, vamos a crear un activador. Esto harÃ¡ que el script se ejecute automÃ¡ticamente cada vez que se aÃ±adan nuevos datos de encuesta.
                        <br>
                        En App Script, ve a **'Activadores' (Trigger)** y crea uno para que tu script 'limpiarNombres' se ejecute **"Al enviar el formulario"**. ğŸš€
                    </p>
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-purple-300 mb-2">Diagrama de Flujo del Activador:</h4>
                        <img src="https://placehold.co/600x200/292524/e7e5e4?text=Flujo+de+Activador" alt="Diagrama de flujo de un activador en Google Apps Script" class="rounded-lg shadow-lg">
                    </div>
                    <p class="text-gray-400 mt-4 italic">
                        Â¿Necesitas ayuda con algÃºn paso o te perdiste? Â¡PregÃºntale a nuestro asistente de IA integrado! ğŸ•â€ğŸ¦º
                    </p>
                `,
                type: 'multipleChoice',
                question: 'Â¿QuÃ© opciÃ³n en Apps Script te permite programar la ejecuciÃ³n de un script?',
                options: ['Run', 'Activadores', 'Debug'],
                answer: 'Activadores'
            },
            {
                phase: 'Fase 5: El Instinto de Liderazgo ğŸ§ ',
                title: 'MÃ³dulo 14: La IA en el AnÃ¡lisis de Datos',
                emoji: 'ğŸ§ ',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">MisiÃ³n: Â¡Aprende del instinto! ğŸ§ </h3>
                    <p class="text-gray-400 mb-4">
                        La IA es el instinto de la manada. Nos ayuda a predecir el comportamiento de los votantes, segmentar audiencias y personalizar mensajes de campaÃ±a a una escala masiva. Con la IA, podemos ir mÃ¡s allÃ¡ de los datos que tenemos y predecir lo que va a pasar, como un perro que sabe cuÃ¡ndo va a llover. â˜”
                    </p>
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-cyan-300 mb-2">IlustraciÃ³n de IA:</h4>
                        <img src="https://placehold.co/600x200/292524/e7e5e4?text=IA+en+AnÃ¡lisis+de+Datos" alt="IlustraciÃ³n de IA analizando datos de votantes" class="rounded-lg shadow-lg">
                    </div>
                `,
                type: 'multipleChoice',
                question: 'Â¿CuÃ¡l es el beneficio clave de usar IA en una campaÃ±a?',
                options: ['Permite predecir el comportamiento de los votantes y segmentar audiencias, ayudando a personalizar mensajes.', 'Genera grÃ¡ficos automÃ¡ticos en Google Sheets.', 'Crea correos electrÃ³nicos masivos.'],
                answer: 'Permite predecir el comportamiento de los votantes y segmentar audiencias, ayudando a personalizar mensajes.'
            },
            {
                phase: 'Fase 5: El Instinto de Liderazgo ğŸ§ ',
                title: 'MÃ³dulo 15: SegmentaciÃ³n de Manadas',
                emoji: 'ğŸ§©',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">MisiÃ³n: Â¡Dividir para conquistar! ğŸ§©</h3>
                    <p class="text-gray-400 mb-4">
                        La IA nos ayuda a segmentar a los votantes en grupos (manadas). Una manada puede ser de votantes jÃ³venes interesados en el medio ambiente, y otra de votantes mayores preocupados por la seguridad. Cada manada recibe un mensaje adaptado a sus intereses. ğŸ—£ï¸
                    </p>
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-cyan-300 mb-2">Diagrama de SegmentaciÃ³n:</h4>
                        <img src="https://placehold.co/600x200/292524/e7e5e4?text=Diagrama+de+SegmentaciÃ³n" alt="Diagrama de votantes segmentados por edad y ubicaciÃ³n" class="rounded-lg shadow-lg">
                    </div>
                `,
                type: 'multipleChoice',
                question: 'Â¿QuÃ© es la segmentaciÃ³n de votantes?',
                options: ['Dividir a los votantes en grupos basados en caracterÃ­sticas comunes.', 'Contar el nÃºmero total de votantes en una base de datos.', 'Analizar el perfil de los candidatos rivales.'],
                answer: 'Dividir a los votantes en grupos basados en caracterÃ­sticas comunes.'
            },
            {
                phase: 'Fase 5: El Instinto de Liderazgo ğŸ§ ',
                title: 'MÃ³dulo 16: Prediciendo el Comportamiento',
                emoji: 'ğŸ”®',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">MisiÃ³n: Â¡Olfateando el futuro! ğŸ”®</h3>
                    <p class="text-gray-400 mb-4">
                        Con modelos de IA, podemos predecir si un votante es "indeciso" o "fiel". Esta informaciÃ³n nos permite enfocar nuestros recursos en aquellos que son mÃ¡s propensos a cambiar su voto. Â¡Es como saber quiÃ©n te va a dar una galleta antes de que la saquen! ğŸª
                    </p>
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-cyan-300 mb-2">Modelo de PredicciÃ³n:</h4>
                        <img src="https://placehold.co/600x200/292524/e7e5e4?text=Modelo+Predictivo+de+Votantes" alt="GrÃ¡fico de probabilidad de voto por votante" class="rounded-lg shadow-lg">
                    </div>
                `,
                type: 'multipleChoice',
                question: 'Â¿QuÃ© es un modelo de IA en una campaÃ±a?',
                options: ['Una maqueta de la sede del partido.', 'Un programa que predice el comportamiento de los votantes.', 'Un tipo de grÃ¡fico en Looker Studio.'],
                answer: 'Un programa que predice el comportamiento de los votantes.'
            },
            {
                phase: 'Fase 6: La Victoria ğŸ†',
                title: 'MÃ³dulo 17: MediciÃ³n de Ladrido: Campos Calculados en Looker Studio',
                emoji: 'ğŸ“',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">MisiÃ³n: Â¡MÃ¡s allÃ¡ de lo obvio! ğŸ¯</h3>
                    <p class="text-gray-400 mb-4">
                        El equipo de campaÃ±a quiere saber si la campaÃ±a estÃ¡ resonando con los jÃ³venes. En Looker Studio, vamos a usar un **Campo Calculado** para clasificar a los votantes por grupos de edad: "Joven" (menor de 30), "Adulto" (30-50) y "Senior" (mayor de 50). AsÃ­ podemos medir el impacto de Puppy en cada grupo.
                    </p>
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-rose-300 mb-2">RecreaciÃ³n de la interfaz de Looker Studio:</h4>
                        <div class="bg-gray-900 rounded-lg p-4">
                            <h5 class="text-sm text-gray-400 mb-2">PestaÃ±a de "Campos Calculados"</h5>
                            <pre class="bg-gray-900 text-green-300 overflow-x-auto"><code>CASE WHEN Edad < 30 THEN "Joven"
     WHEN Edad >= 30 AND Edad <= 50 THEN "Adulto"
     ELSE "Senior"
END</code></pre>
                        </div>
                    </div>
                `,
                type: 'multipleChoice',
                question: 'Â¿QuÃ© funciÃ³n usarÃ­as para crear un campo calculado que clasifique la edad de los votantes en "Joven", "Adulto" o "Senior"?',
                options: ['CASE WHEN Edad < 30 THEN "Joven"', 'SUM(Edad)', 'COUNT(Edad)'],
                answer: 'CASE WHEN Edad < 30 THEN "Joven"'
            },
            {
                phase: 'Fase 6: La Victoria ğŸ†',
                title: 'MÃ³dulo 18: El Rastro del Ã‰xito: AnÃ¡lisis Avanzado',
                emoji: 'ğŸ“Š',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">MisiÃ³n: Â¡Los datos cuentan la historia! ğŸ“ˆ</h3>
                    <p class="text-gray-400 mb-4">
                        Al revisar tu dashboard, notas que los "Amigos de Gatos" de "La Roma" tienen muchos comentarios negativos sobre el trÃ¡fico. Con un campo calculado, podemos crear un "Ãndice de Resentimiento" para cada colonia. Â¡Es una mÃ©trica clave para el equipo de campaÃ±a!
                    </p>
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-rose-300 mb-2">RecreaciÃ³n del Dashboard en Looker Studio:</h4>
                        <div class="bg-gray-900 rounded-lg p-4 flex flex-col items-center">
                            <div class="w-full text-center">
                                <span class="text-xs text-gray-400 uppercase">Ãndice de Resentimiento</span>
                                <p class="text-3xl font-bold text-red-500">80%</p>
                                <span class="text-sm text-gray-500">La Roma - Amigos de Gatos</span>
                            </div>
                            <div class="mt-4 w-full h-48 bg-gray-800 rounded-lg flex items-center justify-center text-gray-500">
                                GrÃ¡fico de Barras de Resentimiento
                            </div>
                        </div>
                    </div>
                `,
                type: 'multipleChoice',
                question: 'Para crear un "Ãndice de Resentimiento" que cuente los comentarios negativos por colonia, Â¿quÃ© tipo de campo calculado usarÃ­as?',
                options: ['Uno que cuente los comentarios positivos.', 'Uno que sume la edad de los votantes.', 'Uno que cuente las menciones de "trÃ¡fico" o "problema".'],
                answer: 'Uno que cuente las menciones de "trÃ¡fico" o "problema".'
            },
            {
                phase: 'Fase 6: La Victoria ğŸ†',
                title: 'MÃ³dulo 19: El Cierre de CampaÃ±a: Decisiones Basadas en Datos',
                emoji: 'ğŸ‰',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">MisiÃ³n: Â¡El Ãºltimo ladrido! ğŸ¾</h3>
                    <p class="text-gray-400 mb-4">
                        Gracias a tu trabajo, Puppy Chiquito PolÃ­tico ha optimizado sus recursos. Al analizar tus dashboards, notaste que los votantes jÃ³venes de "La Roma" son clave. Usando los datos de "Comentarios_Encuesta", creaste mensajes especÃ­ficos sobre la seguridad y el trÃ¡fico. Â¡La campaÃ±a estÃ¡ en su punto mÃ¡s alto! ğŸ¥³
                    </p>
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg shadow-inner">
                        <h4 class="text-lg font-bold text-rose-300 mb-2">Estrategia Final de Puppy:</h4>
                        <img src="https://placehold.co/600x200/292524/e7e5e4?text=Estrategia+Basada+en+Datos" alt="Diagrama de flujo de la estrategia de campaÃ±a" class="rounded-lg shadow-lg">
                    </div>
                `,
                type: 'multipleChoice',
                question: 'Â¿QuÃ© habilidad de las aprendidas fue crucial para el Ã©xito del evento en La Roma?',
                options: ['Identificar votantes indecisos y sus preocupaciones a travÃ©s de los datos.', 'Distribuir volantes en toda la ciudad.', 'Contratar a un entrenador canino famoso.'],
                answer: 'Identificar votantes indecisos y sus preocupaciones a travÃ©s de los datos.'
            },
            {
                phase: 'Fase 7: El Legado ğŸ…',
                title: 'MÃ³dulo 20: El dÃ­a de la elecciÃ³n',
                emoji: 'ğŸ—³ï¸',
                content: `
                    <h3 class="text-2xl font-bold text-fuchsia-400 mb-4">MisiÃ³n: Â¡Aullidos de victoria! ğŸ†</h3>
                    <p class="text-gray-400 mb-4">
                        Â¡Lo lograste! El conteo de votos ha terminado y Puppy Chiquito PolÃ­tico, gracias a tu ayuda, ha sido electo diputado de la Ciudad de MÃ©xico. Tu trabajo como analista de datos fue crucial para esta histÃ³rica victoria. Ahora, solo queda celebrar. ğŸ¥³ğŸ‰
                    </p>
                `,
                type: 'multipleChoice',
                question: 'Â¿QuÃ© aprendiste sobre el anÃ¡lisis de datos para campaÃ±as polÃ­ticas?',
                options: ['Es una herramienta para contar votos.', 'Es una herramienta estratÃ©gica para la toma de decisiones.', 'Solo sirve para hacer grÃ¡ficos.'],
                answer: 'Es una herramienta estratÃ©gica para la toma de decisiones.'
            },
            {
                phase: 'Fase 7: El Legado ğŸ…',
                title: 'MÃ³dulo 21: Â¡Felicidades! Tu Certificado',
                emoji: 'ğŸ“',
                content: `
                    <h2 class="text-3xl font-bold neon-text text-cyan-400 mb-4">Â¡Guau! Â¡Lo Lograste! ğŸ¾ğŸ“</h2>
                    <p class="text-xl mb-6">
                        Â¡Felicidades, <span id="final-dog-name" class="font-bold text-pink-400"></span>! Has completado el curso y te has ganado el prestigioso tÃ­tulo de Sabueso de Datos PolÃ­ticos. Â¡Puppy Chiquito PolÃ­tico estÃ¡ orgulloso!
                    </p>
                    <div class="mt-8">
                        <h3 class="text-xl font-bold text-cyan-300 mb-4">Tu Certificado de Logro</h3>
                        <canvas id="certificate-canvas" class="w-full h-auto bg-gray-800 rounded-lg neon-border"></canvas>
                        <p class="mt-4 text-gray-500 italic">Haz una captura de pantalla para guardar tu certificado.</p>
                        <p class="mt-8 text-lg font-bold text-fuchsia-400 text-center">
                            Â¡La victoria es tuya! ğŸ‰ Tu dedicaciÃ³n y tu olfato para los datos hicieron la diferencia. Recuerda que con las herramientas adecuadas y un poco de instinto, puedes cambiar el mundo. Â¡El futuro es brillante para ti y para el Partido PUP! ğŸ•
                        </p>
                    </div>
                `,
                type: 'certificate',
                question: null,
                answer: null
            }
        ];

        // Referencias a elementos del DOM
        const introScreen = document.getElementById('intro-screen');
        const courseScreen = document.getElementById('course-screen');
        const startForm = document.getElementById('start-form');
        const sidebarModules = document.getElementById('sidebar-modules');
        const courseTitleEl = document.getElementById('course-title');
        const moduleContainer = document.getElementById('module-container');
        const nextModuleButton = document.getElementById('next-module-button');
        const finalDogNameEl = document.getElementById('final-dog-name');
        const aiAssistantButton = document.getElementById('ai-assistant-button');
        const chatModal = document.getElementById('chat-modal');
        const closeChatButton = document.getElementById('close-chat-button');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendChatButton = document.getElementById('send-chat-button');
        const certificateCanvas = document.getElementById('certificate-canvas');

        // FunciÃ³n para mostrar la pantalla
        function showScreen(screen) {
            introScreen.style.display = 'none';
            courseScreen.style.display = 'none';
            screen.style.display = 'flex';
        }

        // Cargar progreso
        function loadProgress() {
            const savedState = JSON.parse(localStorage.getItem('courseState'));
            if (savedState) {
                currentModuleIndex = savedState.currentModuleIndex;
                userName = savedState.userName;
                fullName = savedState.fullName;
                completedModules = savedState.completedModules || [];
                score = savedState.score || 0;
            }
        }

        // Guardar progreso
        function saveProgress() {
            const state = {
                currentModuleIndex,
                userName,
                fullName,
                completedModules,
                score
            };
            localStorage.setItem('courseState', JSON.stringify(state));
        }

        // Renderizar la barra lateral
        function renderSidebar() {
            sidebarModules.innerHTML = '';
            modules.forEach((mod, index) => {
                const isCompleted = completedModules.includes(index) || index === 0;
                const isActive = index === currentModuleIndex;

                const item = document.createElement('div');
                item.className = `sidebar-item cursor-pointer ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : 'opacity-50'}`;
                item.innerHTML = `<span class="text-xl mr-2">${mod.emoji}</span> ${mod.title}`;
                
                if (completedModules.includes(index) || index === 0) {
                    item.addEventListener('click', () => {
                        currentModuleIndex = index;
                        renderModule();
                    });
                }
                
                sidebarModules.appendChild(item);
            });
        }

        // Renderizar mÃ³dulo
        function renderModule() {
            saveProgress();
            renderSidebar();

            const module = modules[currentModuleIndex];
            courseTitleEl.textContent = module.title;
            nextModuleButton.style.display = 'none';

            if (module.type === 'certificate') {
                moduleContainer.innerHTML = module.content;
                const finalDogNameEl = document.getElementById('final-dog-name');
                if (finalDogNameEl) finalDogNameEl.textContent = userName;
                isFinalModule = true;
                drawCertificate(fullName, Math.floor((score / (modules.length - 1)) * 100));
                return;
            } else {
                isFinalModule = false;
            }

            moduleContainer.innerHTML = `
                <div class="p-8 rounded-xl module-card">
                    ${module.content}
                </div>
                <div id="question-area" class="mt-8 p-6 rounded-xl module-card">
                    <h4 class="text-xl font-bold text-cyan-300 mb-4">${module.question}</h4>
                    <div id="question-content"></div>
                    <button id="check-answer-button" class="mt-6 py-3 px-6 text-lg font-bold rounded-lg text-white transition-all duration-300 bg-gradient-to-r from-teal-500 to-cyan-500 hover:from-teal-600 hover:to-cyan-600">
                        Comprobar Respuesta
                    </button>
                    <div id="feedback" class="mt-4 font-bold"></div>
                </div>
            `;

            const questionContent = document.getElementById('question-content');
            const checkAnswerButton = document.getElementById('check-answer-button');
            const feedbackEl = document.getElementById('feedback');

            if (module.type === 'multipleChoice') {
                module.options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.className = 'w-full text-left p-3 rounded-lg mb-2 bg-gray-700 hover:bg-gray-600 transition-colors duration-200';
                    button.addEventListener('click', () => {
                        const allButtons = questionContent.querySelectorAll('button');
                        allButtons.forEach(btn => btn.classList.remove('border-2', 'border-cyan-400'));
                        button.classList.add('border-2', 'border-cyan-400');
                        checkAnswerButton.disabled = false;
                        checkAnswerButton.dataset.answer = option;
                    });
                    questionContent.appendChild(button);
                });
                checkAnswerButton.dataset.correctAnswer = module.answer;
            } else if (module.type === 'shortAnswer') {
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = 'Escribe tu respuesta aquÃ­...';
                input.className = 'w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:border-cyan-500';
                questionContent.appendChild(input);
            } else if (module.type === 'dragAndDrop') {
                questionContent.innerHTML = `
                    <div class="flex flex-col md:flex-row justify-around">
                        <div id="drag-items" class="flex flex-col items-center space-y-4 mb-8 md:mb-0">
                            ${module.dragItems.map(item => `
                                <div id="${item.id}" draggable="true" class="draggable p-4 bg-purple-600 text-white rounded-lg cursor-grab">
                                    ${item.text}
                                </div>
                            `).join('')}
                        </div>
                        <div id="drop-targets" class="flex flex-col items-center space-y-4">
                            ${module.dropTargets.map(target => `
                                <div id="${target.id}" class="dropzone p-4 bg-gray-800 text-gray-400 rounded-lg w-64">
                                    ${target.text}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                setupDragAndDrop(module.correctMapping);
            }

            checkAnswerButton.onclick = () => checkAnswer();
            checkAnswerButton.style.display = 'block';
        }

        // Configurar drag and drop
        function setupDragAndDrop(correctMapping) {
            const draggables = document.querySelectorAll('.draggable');
            const dropzones = document.querySelectorAll('.dropzone');

            draggables.forEach(draggable => {
                draggable.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.id);
                });
            });

            dropzones.forEach(dropzone => {
                dropzone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropzone.classList.add('hovered');
                });
                dropzone.addEventListener('dragleave', () => {
                    dropzone.classList.remove('hovered');
                });
                dropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('hovered');
                    const draggableId = e.dataTransfer.getData('text/plain');
                    const draggableEl = document.getElementById(draggableId);
                    if (draggableEl) {
                        dropzone.appendChild(draggableEl);
                    }
                });
            });
        }

        // Comprobar la respuesta
        function checkAnswer() {
            const module = modules[currentModuleIndex];
            let isCorrect = false;
            let userAnswer;
            const feedbackEl = document.getElementById('feedback');

            if (module.type === 'multipleChoice') {
                userAnswer = document.querySelector('#question-content button.border-cyan-400')?.textContent;
                if (userAnswer === module.answer) {
                    isCorrect = true;
                }
            } else if (module.type === 'shortAnswer') {
                userAnswer = document.getElementById('question-content').querySelector('input').value.trim();
                const cleanUserAnswer = userAnswer.toLowerCase().replace(/[.,!?Â¡Â¿]/g, '');
                const cleanCorrectAnswer = module.answer.toLowerCase().replace(/[.,!?Â¡Â¿]/g, '');
                if (cleanUserAnswer.includes(cleanCorrectAnswer)) {
                    isCorrect = true;
                }
            } else if (module.type === 'dragAndDrop') {
                isCorrect = true;
                for (const dragId in module.correctMapping) {
                    const dropzoneId = module.correctMapping[dragId];
                    const dropzoneEl = document.getElementById(dropzoneId);
                    if (!dropzoneEl || dropzoneEl.firstElementChild?.id !== dragId) {
                        isCorrect = false;
                        break;
                    }
                }
            }

            if (isCorrect) {
                feedbackEl.textContent = 'Â¡Correcto! Â¡Guau-maravilloso! ğŸ¾';
                feedbackEl.className = 'mt-4 font-bold text-green-400';
                nextModuleButton.style.display = 'block';
                if (!completedModules.includes(currentModuleIndex)) {
                    score += 1;
                    completedModules.push(currentModuleIndex);
                }
            } else {
                feedbackEl.textContent = 'Â¡Incorrecto! No te rindas, intenta de nuevo. Â¡Los grandes sabuesos tambiÃ©n se equivocan! ğŸ§';
                feedbackEl.className = 'mt-4 font-bold text-red-400';
            }
        }
        
        // Dibujar certificado
        function drawCertificate(name, score) {
            const ctx = certificateCanvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                certificateCanvas.width = img.width;
                certificateCanvas.height = img.height;
                ctx.drawImage(img, 0, 0);

                ctx.font = 'bold 60px Inter';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#10b981';
                ctx.shadowColor = '#06b6d4';
                ctx.shadowBlur = 10;
                ctx.fillText('Â¡CERTIFICADO DE SABUESO!', certificateCanvas.width / 2, 200);

                ctx.font = '40px Inter';
                ctx.fillStyle = '#f43f5e';
                ctx.fillText('Este certificado es otorgado a:', certificateCanvas.width / 2, 300);

                ctx.font = 'bold 80px Inter';
                ctx.fillStyle = '#fff';
                ctx.fillText(name, certificateCanvas.width / 2, 400);

                ctx.font = '40px Inter';
                ctx.fillStyle = '#d1d5db';
                ctx.fillText('Por haber completado el curso de', certificateCanvas.width / 2, 500);

                ctx.font = 'bold 50px Inter';
                ctx.fillStyle = '#8b5cf6';
                ctx.fillText('AnÃ¡lisis de Datos PolÃ­ticos', certificateCanvas.width / 2, 560);

                ctx.font = '40px Inter';
                ctx.fillStyle = '#d1d5db';
                ctx.fillText(`Con una calificaciÃ³n de ${score}%`, certificateCanvas.width / 2, 650);
            };
            img.src = 'https://placehold.co/1200x800/1e293b/d1d5db?text=Certificado+de+AnÃ¡lisis+de+Datos';
        }

        // LÃ³gica de inicio
        startForm.addEventListener('submit', (e) => {
            e.preventDefault();
            userName = document.getElementById('dog-name').value;
            fullName = document.getElementById('full-name').value;
            saveProgress();
            showScreen(courseScreen);
            renderModule();
        });

        nextModuleButton.addEventListener('click', () => {
            currentModuleIndex++;
            renderModule();
        });

        // LÃ³gica del chat
        aiAssistantButton.addEventListener('click', () => {
            chatModal.style.display = 'flex';
        });

        closeChatButton.addEventListener('click', () => {
            chatModal.style.display = 'none';
        });

        sendChatButton.addEventListener('click', async () => {
            const userMessage = chatInput.value;
            if (!userMessage.trim()) return;

            // Mostrar el mensaje del usuario
            addMessageToChat('user', userMessage);
            chatInput.value = '';

            // Mostrar "escribiendo..."
            addMessageToChat('bot', '...', true);

            try {
                const payload = {
                    contents: [{ parts: [{ text: `ActÃºa como un asistente de campaÃ±a perruno y responde con un tono divertido y con analogÃ­as de perros. Pregunta del usuario: ${userMessage}` }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: "Eres un asistente de IA perruno, divertido y experto en anÃ¡lisis de datos para campaÃ±as polÃ­ticas. MantÃ©n el tono temÃ¡tico." }]
                    },
                };
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const botResponse = result.candidates?.[0]?.content?.parts?.[0]?.text || 'Guau, algo saliÃ³ mal. IntÃ©ntalo de nuevo.';

                // Eliminar el mensaje de "escribiendo..." y mostrar la respuesta
                chatMessages.removeChild(chatMessages.lastElementChild);
                addMessageToChat('bot', botResponse);
            } catch (error) {
                console.error('Error with Gemini API:', error);
                chatMessages.removeChild(chatMessages.lastElementChild);
                addMessageToChat('bot', 'Â¡Guau! No puedo encontrar la respuesta en este momento. La conexiÃ³n con la manada se perdiÃ³. ğŸ“¡');
            }
        });

        function addMessageToChat(sender, message, isTyping = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-3 rounded-lg max-w-[80%] ${sender === 'user' ? 'bg-blue-600 self-end ml-auto' : 'bg-gray-700 self-start mr-auto'}`;
            messageDiv.textContent = message;
            if (isTyping) {
                messageDiv.classList.add('italic');
            }
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Inicio de la aplicaciÃ³n
        window.onload = () => {
            loadProgress();
            if (userName && fullName) {
                showScreen(courseScreen);
                renderModule();
            } else {
                showScreen(introScreen);
            }
        };

    </script>
</body>
</html>
